<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WGS Coverage Plot</title>
    <style>{{ bootstrap_css }}</style>
    <script>{{ jquery_js }}</script>
    <script>{{ popper_js }}</script>
    <script>{{ bootstrap_js }}</script>
    <style>{{ select2_css }}</style>
    <script>{{ select2_js }}</script>
    <script type="text/javascript">
        {% include "js/wgscovplot.bundle.js" %}
    </script>
</head>
<body>

    {% block content%}
        {% include "wgscovplot_controlmenu_gui.html" %}
    {% endblock %}
    <script type="text/javascript">
        {% include "js/wgscovplot.js" %}
    </script>
    <script>
        /**
         * Reference Sequence
         * @type {string}
         */
        window.refSeq = "{{ ref_seq }}";

        /**
         * List of samples name
         */
        window.samples = {{ samples_name }}

        /**
         * Object of depth data
         * @type {Object}
         * {sample_name: Array<number>}
         */
        window.depths = {{ depth_data }};

        /**
         * Object of variant data
         * @type {Object}
         * {sample_name: Array<Object>}
         */
        window.variants = {{ variant_data }};
        /**
         * Dict of gene or amplicon features
         * @type {Dict[]}
         */
        const geneFeatureAmpliconData = {{ gene_feature_data }}

        /**
         * Dict of Amplicon Depth Coverage
         * @type {Object}
         */
        const ampliconDepthBarData = {{ amplicon_data }}

        window.variantMatrix = {{ variant_matrix }}
        window.mutations = {{ mutation }}

        /**
         * Whether to plot gene feature or not
         * @type {boolean}
         * Get from Python Boolean which is True or False
         */
        const geneFeature = {{ gene_feature|tojson }}

        /**
         * Whether amplicon coverage plot or not
         * @type {boolean}
         * Get from Python Boolean which is True or False
         */
        const amplicon = {{ amplicon|tojson }}

        const refSeqLength = window.refSeq.length;

        /**
         * A closure lastYAxisScale is used to keep track the scale settings of a last sample on the chart before it was remove
         * @type {function(): string}
         */
        var lastYAxisScale = (function (){
            var yAxisScale;
            return function (){
                return yAxisScale;
            };
        })();

        /**
         * A closure lastYAxisMax is used to keep track the scale settings of a last sample on the chart before it was remove
         * @type {function(): number}
         */
        var lastYAxisMax = (function (){
            var yAxisMax;
            return function (){
                return yAxisMax;
            };
        })();

        /**
         * The max value is set for y-Axis
         * @type {number}
         */
        const maxDepth = {{ max_depth }}

        function updateChartDivSize() {
            let BOTTOM_PADDING = 20;
            let top = $chart.getBoundingClientRect().top;
            let height = window.innerHeight - top - BOTTOM_PADDING;
            if (height < 300) {
                height = 300;
            }
            $chart.style.height = height + 'px';
            $chart.style.width = window.innerWidth + 'px';
            chart.resize();
            $variantHeatmap.style.height = height + 'px';
            $variantHeatmap.style.width = window.innerWidth + 'px';
            variantHeatmap.resize();
        }

        document.addEventListener("DOMContentLoaded", function(event) {
            var $chart = document.getElementById("chart");
            var $variantHeatmap = document.getElementById("varmap-chart");
            window.$chart = $chart;
            window.$variantHeatmap = $variantHeatmap;
            var chart = wgscovplot.echarts.init($chart, "white", {renderer: "canvas"});
            var variantHeatmap = wgscovplot.echarts.init($variantHeatmap, "white", {renderer:"canvas"})
            window.chart = chart;
            window.variantHeatmap = variantHeatmap;
            updateChartDivSize();
            initWgscovplotRenderEnv();
        })
        window.addEventListener("resize", updateChartDivSize);
        initWgscovplotEvent();
    </script>
</body>
</html>