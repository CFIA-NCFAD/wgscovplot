<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WGS Coverage Plot</title>
    <script>{{ jquery_js }}</script>
    <script>{{ echarts_js }}</script>
    <style>{{ select2_css }}</style>
    <script>{{ select2_js }}</script>
    <style>
        img {
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 5px 16px;
            transition: 0.3s;
        }

        .tab button:hover {
            background-color: #ddd;
        }

        .tab button.active {
            background-color: #ccc;
        }

        .chart-container {
            display: none;
            padding: 6px 12px;
        }

        #table_id {
            font-family: Arial, Helvetica, sans-serif;
            border-collapse: collapse;
            padding-top: 1%;
            width: 100%;
        }

        #table_id td, #table_id th {
            border: 1px solid #ddd;
            padding: 8px;
        }

        #table_id tr:nth-child(even){
            background-color: #f2f2f2;
        }

        #table_id tr:hover {
            background-color: #ddd;
        }

        #table_id tr {
            justify-content: space-between;
        }

        #table_id th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #04AA6D;
            color: white;
            justify-content: space-between;
        }
        .sidepanel  {
            width: 0;
            position: fixed;
            z-index: 1;
            height: 100%;
            top: 0;
            left: 0;
            background-color: #ffff;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
        }

        .sidepanel a {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 18px;
            color: #818181;
            display: block;
            transition: 0.3s;
        }

        .sidepanel a:hover {
            color: #f1f1f1;
        }

        .sidepanel .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
        }

        .openbtn {
            font-size: 15px;
            cursor: pointer;
            background-color: #666;
            color: white;
            padding: 10px 15px;
            border: none;
            display: none
        }

        .openbtn:hover {
            background-color:#444;
        }

        .accordion {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            transition: 0.4s;
        }

        .active, .accordion:hover {
            background-color: #ccc;
        }

        .accordion:after {
            content: '\002B';
            color: #777;
            font-weight: bold;
            float: right;
            margin-left: 5px;

        }

        .accordion.active:after {
            content: "\2212";

        }

        .panel {
            padding: 0 18px;
            background-color: white;
            max-height: 0;
            overflow: scroll;
            transition: max-height 0.2s ease-out;
        }
        .row-content {
            margin:0px auto;
            padding: 10px 0px 10px 0px;
            border-bottom: 2px ridge;
        }

    </style>
</head>
<body>

    <div class="tab">
        <button class="tablinks" onclick="openNav()">☰ Chart Options</button>
        <button class="tablinks" onclick="showChart(event,'chart')">Coverage Plot</button>
        <button class="tablinks" onclick="showChart(event,'table_id')">Summary Information</button>
        <button class="tablinks" onclick="showChart(event,'fqa_id')">FQA</button>
        <button class="tablinks" onclick="showChart(event,'about_id')">About</button>
    </div>
     
    <div id="chart" class="chart-container" style="width:100%; height: 900px;"></div>

    <div id="sidepanel_id" class="sidepanel">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">×</a>
        <button class="accordion">General</button>

        <div class="panel">
            <p>
            <label for="samples">Samples:</label>
            <select class="selected-samples" multiple="multiple" style="width: 75%" >
                {% for id, sample in samples_name.items() %}
                    <option value={{sample}}>{{sample}}</option>
                {% endfor %}
            </select>
            </p>
        </div>

        <button class="accordion">Axis</button>
        <div class="panel">
            <p>Scale:  
                <select id="scale" onchange="setScale()" style="width: 25%">
                    <option value="value" >Linear</option>
                    <option value="log" selected>Log</option>
                </select>
            </p>
            <p> 
                <form id="ymaxform">
                    <label for="ymaxform">yMax: </label>
                    <input type="number" id="ymax" value=100000 style="width: 30%">
                    <input type="button" onclick="setYMax()" value="Set yMax">
                </form>
            </p>

        </div>

        <button class="accordion">Tooltip</button>
        <div class="panel">
            <p>Show Tooltip:  
                <select id="showtooltip" onchange="tooltipOption()" style="width: 25%">
                    <option value="false" >Disable</option>
                    <option value="true" selected>Enable</option>
                </select>
            </p>
        </div>
        <button class="accordion">Data Zoom</button>
        <div class="panel">
            <p>Show Slider:  
                <select id="showslider" onchange="dataZoomOption()" style="width: 25%">
                    <option value="true" selected>Enable</option>
                    <option value="false">Disable</option>
                </select>
            </p>
            <form id="dataZoom">
                <label for="start_pos">Start Pos:</label><br>
                <input type="number" id="start_pos" value=1><br>
                <label for="start_pos">End Pos:</label><br>
                <input type="number" id="end_pos" value={{ref_seq_length}}><br><br>
                <input type="button" onclick="setDataZoom()" value="Set DataZoom">
                <input type="button" onclick="resetDataZoom()" value="Reset DataZoom">
            </form>
            <br>
        </div>
    </div>
    <div id="about_id" class="chart-container">
        <h2>Standalone HTML Interactive Coverage Plot (SHICP)</h2>
        <p>The tool generates the HTML Interactive Coverage Plot given coverage depth information, variants and DNA gene features.</p>
        <h3 class="row-content">Dependencies</h3>

        <h4>Software Version</h4>
        <ul>
            <li>The tool is still in the development phases with current version is 1.0.0dev</li>
        </ul>
        <h4>Programming Languages</h4>
        <ul>
            <li>Python (>= 3.6)</li>
            <li>HTML/CSS/Javascript</li>
        </ul>
        <h4>Tools/Libraries</h4>
        <ul>
            <li><a style="text-decoration: none" href="https://echarts.apache.org/en/index.html">Echarts</a></li>
            <li>Python libraries: Biopython, rich, typer, pandas</li>
            <li><a style="text-decoration: none" href="https://select2.org/">select2</a></li>
            <li><a style="text-decoration: none" href="https://jinja.palletsprojects.com/en/2.11.x/templates/">jinja2</a></li>
        </ul>
        <h3 class="row-content">Usage</h3>
        <h4>Prepare Samples Data</h4>
        <p>The tsv file of samples data (samples.tsv) is as follow. Note that no header is needed</p>
        <table style="border:solid; border-collapse: collapse;">
            <tr>
              <td style="border: solid black;border-collapse: collapse;">Sample-01</td>
              <td style="border: solid black;border-collapse: collapse;">path/to/sample-01-coverage-depth</td>
              <td style="border: solid black;border-collapse: collapse;">path/to/sample-01-variant-vcf</td>
            </tr>
            <tr>
              <td style="border: solid black;border-collapse: collapse;">Sample-02</td>
              <td style="border: solid black;border-collapse: collapse;">path/to/sample-02-coverage-depth</td>
              <td style="border: solid black;border-collapse: collapse;">path/to/sample-02-variant-vcf</td>
            </tr>
            <tr>
                <td style="border: solid black;border-collapse: collapse;">Sample-03</td>
                <td style="border: solid black;border-collapse: collapse;">path/to/sample-03-coverage-depth</td>
                <td style="border: solid black;border-collapse: collapse;">path/to/sample-03-variant-vcf</td>
            </tr>
        </table>
        <p>Others data</p>
        <ul>
            <li>Reference Sequences (reference.fasta)</li>
            <li>Genbank file contains gene features (sequence_genbank.gb)</li>
        </ul>
        <h4>Output</h4>
        <p>The tool will generate the Coverage Plot for samples in HTML file</p>
        <h4>Command</h4>
        <p>shicp -s samples.tsv -r reference.fasta -o sequencing_coverage_plot.html -g sequence_genbank.gb</p>

        <h3 class="row-content">HTML File Structure</h3>
        <ul>
            <li><strong>Chart Options Tab: </strong>allows user to customize chart display such as select which samples to be displayed, set datazoom, tooltips</li>
            <li><Strong>Coverage Plot Tab:</Strong> displays Coverage Plot for selected samples in which user can do interactive oprerations such as zoom in/out, view for specific regions ect...</li>
            <li><strong>Summary Information Tab: </strong>displays summary information for all samples included in an analysis</li>
            <li><strong>About Tab: </strong>Sofware information, user guide</li>
        </ul>

        <h3 class="row-content">Author</h3>
        <ul>
            <li>Development Lead: Peter Kruczkiewicz (<a href="mailto:peter.kruczkiewicz@gmail.com">peter.kruczkiewicz@gmail.com</a>)</li>
            <li>Software Developer: Hai Nguyen (<a href="mailto:nhhaidee@gmail.com">nhhaidee@gmail.com</a>)</li>
        </ul>
        <h3 class="row-content">License</h3>
        <ul>
            <a href="https://inspection.canada.ca/science-and-research/our-laboratories/ncfad-winnipeg/eng/1549576575939/1549576643836"><img src="https://avatars.githubusercontent.com/u/83306868?s=200&v=4" width="50" height="50"></a>
            <p style="text-align: center"><strong>&copy 2021 Canadian Food Inspection Agency of Canada, Government of Canada.</strong></p>
            <p style="text-align: center"><strong>Distributed under the MIT license.</strong></p>
        </ul>
        
    </div>

    <div id="fqa_id" class="chart-container">
        <h4>What happens when the number of samples shown on the chart changed?</h4>
        <ul>
            <li>By the default, at first up to 3 first samples are selected for displaying on the charts</li>
            <li>The entire chart will be re-rendered if you select/change samples to be displayed and you need to set your chart options again, changing other options will not re-render the entire chart</li>
        </ul>

        <h4>What happens when browser zoom is set more than 100%?</h4>
        <ul>
            <li>Some minor graphic (such as some items get cut off) issues may happen. To fix this type of issue, try to adjust browser zoom and this may allow you to have better view</li>
        </ul>

        <h4>How many simultaneous samples are on the chart for the best view?</h4>
        <ul>
            <li>It is recommended that having around 5 simultaneous samples on the chart for the best view</li>
        </ul>

        <h4>What will you do when the plot is distorted or minimized?</h4>
        <ul>
            <li>This issue could happen when you shrink and maximize browser, to restore plot display just simply refresh browser</li>
        </ul>

    </div>
    <table id="table_id" class="chart-container">
        <tr>
            <th>Sample Name</th>
            <th>Mean Coverage</th>
            <th>Median Coverage</th>
            <th>Genome Coverage(>= 10x)</th>
            <th>Low Coverage Positions (< 10X) </th>
            <th>No Coverage Positions (0X)</th>
            <th>Low Coverage Regions (< 10X)</th>
            <th>No Coverage Regions (0X)</th>
        </tr>
        {% for data_info in coverage_stat %}
            <tr>
                <td>{{ data_info[0] }}</td>
                <td>{{ data_info[1] }}</td>
                <td>{{ data_info[2] }}</td>
                <td>{{ data_info[3] }}</td>
                <td>{{ data_info[4] }}</td>
                <td>{{ data_info[5] }}</td>
                <td>{{ data_info[6] }}</td>
                <td>{{ data_info[7] }}</td>
            </tr>
        {% endfor %}
    </table>

    <script>
        (function() {
            containers = document.getElementsByClassName("chart-container");
            if(containers.length > 0) {
                containers[0].style.display = "block";
            }
        })()

        function showChart(evt, chartID) {
            let containers = document.getElementsByClassName("chart-container");
            for (let i = 0; i < containers.length; i++) {
                    containers[i].style.display = "none";
            }

            let tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = "tablinks";
            }

            document.getElementById(chartID).style.display = "block";
            evt.currentTarget.className += " active";
        }

        function openNav() {
            document.getElementById("sidepanel_id").style.width = "20%";
        }

        function closeNav() {
            document.getElementById("sidepanel_id").style.width = "0";
        }
        var acc = document.getElementsByClassName("accordion");

        for (var i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var panel = this.nextElementSibling;
                if (panel.style.maxHeight) {
                    panel.style.maxHeight = null;
                } else {
                    panel.style.maxHeight = panel.scrollHeight + 200 + "px";
                } 
            });
        }
    </script>


    <script>

        var ref_seq = "{{ ref_seq }}";
        var ref_len = ref_seq.length;
        var gird_index_length;
        var positions = [...Array(ref_len + 1).keys()];  // create array from range 0 to (ref_len + 1)
        positions.shift(); // remove zero

        var ntColor = {
            "A": "#F00",
            "C": "#0F0",
            "G": "#00F",
            "T": "#0FF",
        }

        //window.depths = depths;
        var $chart = document.getElementById('chart');
        window.$chart = $chart;
        var chart = echarts.init($chart, 'white', {renderer: 'canvas'});
        window.chart = chart;


        /////////////// Define Gene Feature /////////////////////
        var gene_feature  = {{ gene_feature }}
        var y_start;
        function renderItem(params, api){
            var categoryIndex = api.value(0);
            
            var start = api.coord([api.value(1), categoryIndex]);
            if (categoryIndex==0){
                y_start = start[1]
            }
            var end = api.coord([api.value(2), categoryIndex]);
            var height = api.size([0,1])[1] * 15;
            var width = end[0] - start[0] ;
            var x = start[0];
            var y = y_start - height/2  - api.value(3);
            /* 5 Points of shape
            --------------------
            |                     \
            |                      \
            |                      /
            |                     /
            --------------------                
            */                     
            var points = [
                [x, y],
                [x + width - 5 , y],
                [x + width , y - height / 2 ],
                [x + width - 5 , y - height ],
                [x, y - height ]
            ]
            var shape = echarts.graphic.clipPointsByRect(points, 
                {
                    x: params.coordSys.x,
                    y: params.coordSys.y,
                    width: params.coordSys.width,
                    height: params.coordSys.height
            });
            return shape && {
                type: 'polygon',
                shape: {
                    points: shape
                },
                style : api.style(
                    {   
                        stroke: 'black'
                    }
                ),
                textContent: {
                    type: 'text',
                    style: {
                        text: gene_feature[categoryIndex].name, 
                        fill: gene_feature[categoryIndex].itemStyle.color,
                        fontStyle: 'normal',
                        fontSize: 12,
                        fontWeight: 'bolder'
                    }
                },
                textConfig:{
                    position: 'top',
                    distance: 20, 
                    rotation: 0.7
                }
            };
        }

        function getGeneFeatureSeries(index){
            var feature_series =[]
            feature_series.push({
                type: "custom",
                xAxisIndex: index,
                yAxisIndex: index,
                labelLayout:{
                    //hideOverlap: true,
                },
                renderItem:renderItem,
                data: gene_feature,
                tooltip:{
                    trigger: "item",
                    enterable: true,
                    appendToBody: true,
                    renderMode: "html",
                    borderRadius: 6,
                    borderWidth: 2,
                    showContent: "true",
                    textStyle: {
                        fontSize: 15,
                        fontWeight: "bolder"
                    },
                    formatter: function (params){
                        var output = ''
                        output += 'Feature Name: ' +  params.name + '<br/>' + 'Start pos: ' + params.value[1].toLocaleString() + '<br/>' + 'End pos: ' + params.value[2].toLocaleString() + '<br/>' + 'Feature length: ' + (params.value[2] - params.value[1] + 1).toLocaleString()
                        return output
                    }
                }
            })
            return feature_series
        }
        ///////////////////// End of Gene Feature/////////////////////

        function getXAxes(samples, ref_len) {
            var axes = [];
            for (var [i, sample] of samples.entries()) {
                axes.push({
                    type: "value",
                    gridIndex: i,
                    min: 1,
                    max: ref_len,
                    axisLabel: {
                        interval: "auto"
                    }
                });
            }
            axes.push({
                    type: "value",
                    gridIndex: samples.length,
                    min: 1,
                    max: ref_len,
                    axisLabel: {
                        interval: "auto"
                    } 
            })
            return axes;
        }

        function getYAxes(samples, scaletype, ymax) {
            var axes = [];
            for (var [i, sample] of samples.entries()) {
                axes.push({
                    type: scaletype,
                    gridIndex: i,
                    name: sample,
                    nameTextStyle: {
                        fontStyle: "normal",
                        fontWeight: "bolder"
                    },
                    nameLocation: "end",
                    min: 1,
                    max: ymax,
                    minorSplitLine: { 
                        show: true
                    }
                });
            }
            axes.push({
                max: 80,
                gridIndex: samples.length,
                show: false
            })
            return axes;
        }

        function getDatasets(depths, positions) {
            var datasets = [];
            for (var [i, depthArray] of depths.entries()) {
                datasets.push({
                    dimensions: [
                        {name : "depth", type: "int"},
                        {name: "position", type: "int"}
                    ],
                    source: {
                        position: positions,
                        depth: depthArray
                    }
                });
            }
            return datasets;
        }

        function getDepthSeries(samples) {
            var series = []
            for (var [i, sample] of samples.entries()) {
                series.push({
                    type: "line",
                    xAxisIndex: i,
                    yAxisIndex: i,
                    areaStyle: {
                        color: '#666'
                    },
                    encode: {
                        x: "position",
                        y: "depth",
                    },
                    symbol: "none",
                    datasetIndex: i,
                    lineStyle: {
                        color: '#666',
                        opacity: 0
                    },
                    large: true,
                })
            }
            return series
        }

        function getVariantsSeries(variants, depths) {
            var series = []
            for (var [i, varMap] of variants.entries()) {
                (function(i, varMap) {
                    series.push({
                        type: "bar",
                        xAxisIndex: i,
                        yAxisIndex: i,
                        data: Object.keys(varMap).map((x) => [parseInt(x), depths[i][x]]),
                        barWidth: 2,
                        itemStyle: {
                            color: function (params) {
                                var pos = params.data[0];
                                var nt = variants[i][pos]
                                if (ntColor.hasOwnProperty(nt[0][0])) {
                                    return ntColor[nt[0][0]]
                                } //else {
                                    //console.log(variants.length, pos, i)
                                //}
                                return "#333";
                            }
                        }
                    })
                })(i, varMap);
            }
            return series
        }

        function getGrids(samples) {
            var n = samples.length + 1;
            var last_height;
            var last_top;
            var grids = Object.keys(samples).map(function (sample) {
                last_height = (1 / n * 100) - 6
                if (n == 2){ // Only 1 sample (1 sample + gene feature plot)
                    last_height = 70
                    return {
                        "show": true,
                        "height": "70%" // plot display in nearly full scale
                    };
                }
                return {
                    "show": true,
                    "height": (1 / n * 100) - 6 + "%"
                };
            });
            grids.forEach(function (grid, idx) {
                //var padTop = idx === 1 ? 5 : 3
                var padTop = 4
                last_top = (idx / n * 100) + padTop
                grid.top = (idx / n * 100) + padTop + "%"
            })
            grids.push({
                show: true,
                height: "8%",
                top: last_height + last_top + 3 + "%"
            })
            return grids
        }

        function meanCoverage(depths, start, end, gridIndex) {
            var total = 0;
            if (start < end){
                for (var i = start - 1; i <= end - 1; i++){
                    total +=  depths[gridIndex][i]
                }
                return total/(end-start+1)
            }
            else if (start == end){
                return depths[gridIndex][start]
            }
        }

        function genomeCoverage(depths, start, end, gridIndex, low) {
            var total = 0;
            for (var i = start - 1; i <= end - 1; i++){
                if (depths[gridIndex][i] >= low){
                    total += 1
                }
            }
            return total/(end-start+1) * 100
        }

        function median(arr) {
            arr.sort( function(a,b) {return a - b;} );
            var half = Math.floor(arr.length/2);
            if(arr.length % 2)
                return arr[half];
            else
                return (arr[half-1] + arr[half]) / 2.0;
        }

        function medianCoverage(depths, start, end, gridIndex) {
            var sub_array = depths[gridIndex].slice(start-1, end)
            return median(sub_array)
        }

        function getTooltips(samples, depths, variants){
            return [{
                trigger: "axis",
                enterable: true,
                appendToBody: true,
                renderMode: "html",
                showContent: true,
                formatter: function (params) {
                    var output = "";
                    var param = params[0];
                    var i = param.axisIndex;
                    var position = param.data[1];
                    if (i < samples.length /*&& variants[i].hasOwnProperty(position)*/){
                        var sample = samples[i];
                        var depth = param.data[0];
                        var start_pos, end_pos;
                        //start_pos = Math.floor(chart.getOption().dataZoom[0].start * ref_len / 100);
                        start_pos = Math.floor(chart.getOption().dataZoom[0].startValue)
                        //end_pos = Math.floor(chart.getOption().dataZoom[0].end * ref_len / 100);
                        end_pos = Math.floor(chart.getOption().dataZoom[0].endValue)
                        var mean_cov;
                        mean_cov = meanCoverage(depths, start_pos, end_pos, i).toFixed(2);
                        var median_cov;
                        median_cov = medianCoverage(depths, start_pos, end_pos, i).toFixed(2);
                        var genome_cov;
                        genome_cov = genomeCoverage(depths, start_pos, end_pos, i, 10).toFixed(2)
                        output += "<b>" + sample + "</b><br/>" + 'Start pos: ' + start_pos.toLocaleString() + '<br/>' + 'End pos: ' + end_pos.toLocaleString() + '<br/>';
                        output += 'Mean Coverage: ' + mean_cov + 'X' + '<br/>';
                        output += 'Median Coverage: ' + median_cov + 'X' + '<br/>';
                        output += 'Genome Coverage ( >= 10x): ' + genome_cov + '%' + '<br/>';
                        output += 'Position: ' + position.toLocaleString() + '<br/> Coverage Depth: ' + depth.toLocaleString() + '<br/>';
                        
                        if (variants[i].hasOwnProperty(position)){
                            output += 'Ref: ' + ref_seq.substring(position-1, position-1 + variants[i][position][0].length) + '<br/>'
                            output = output + 'Variant: ' + variants[i][position][1]
                        }
                        else{
                            output += 'Ref: ' + ref_seq[position-1] + '<br/>'
                        }
                        return output;
                    }
                    return output
                }
            }] 
        }

        function getOption(){
            var default_num_chart = 3; // At the beginning display maximum 3 samples
            // Original data
            var origin_samples = {{ samples_name }}
            var origin_depths = {{ depth_data }};
            var origin_variants = {{ variant_data }};

            var samples = [];
            var depths = []
            var variants = []

            for (const [key, entries] of Object.entries(origin_samples)){
                if (key < default_num_chart){
                    samples.push(entries)
                    depths.push(origin_depths[entries])
                    variants.push(origin_variants[entries])
                }
            }
            gird_index_length = samples.length
            var options = {
                title: {
                },
                dataset: getDatasets(depths, positions),
                xAxis: getXAxes(samples, ref_len),
                yAxis: getYAxes(samples, "log", 100000),
                series: [...getDepthSeries(samples),...getVariantsSeries(variants, depths), ...getGeneFeatureSeries(gird_index_length)],
                tooltip: getTooltips(samples, depths, variants),
                toolbox: {
                    show: "true",
                    feature: {
                        dataView: {
                            readOnly: false
                        },
                        restore: {},
                        saveAsImage: {
                            name: "Coverage_Plot"
                        }
                    }
                },
                dataZoom: [
                    {
                        type: "inside",
                        filterMode: 'none',
                        xAxisIndex: [...Array(gird_index_length + 1).keys()]
                    },
                    {
                        show: true,
                        filterMode: 'none',
                        xAxisIndex: [...Array(gird_index_length + 1).keys()],
                        type: "slider"
                    }
                ],
                grid: getGrids(samples)
            };
            return options
        }

        function tooltipOption(){
            var tooltipx = document.getElementById('showtooltip').value;
            if (tooltipx=='false'){
                chart.setOption({
                    tooltip:{showContent: false}
                });
            }
            else{
                chart.setOption({
                    tooltip:{showContent: true}
                });
            }
        }

        function setScale(){
            var scaletype = document.getElementById('scale').value;
            var yaxis_option = chart.getOption().yAxis;
            if (scaletype == 'value'){
                for(let i = 0 ; i < gird_index_length; i++){
                    yaxis_option[i].type = scaletype
                    yaxis_option[i].min = 0
                    yaxis_option[i].max = 40000
                }
                chart.setOption({yAxis: yaxis_option})
                document.getElementById('ymax').value = 40000
            }
            else{
                for(let i = 0 ; i < gird_index_length; i++){
                    yaxis_option[i].type = scaletype
                    yaxis_option[i].min = 1
                    yaxis_option[i].max = 100000
                }
                chart.setOption({yAxis: yaxis_option})
                document.getElementById('ymax').value = 100000
            }
        }

        function dataZoomOption(){
            var sliderx = document.getElementById('showslider').value;
            if (sliderx=="false"){
                chart.setOption({
                    dataZoom: [
                    {
                        type: "inside",
                        filterMode: 'none',
                        xAxisIndex: [...Array(gird_index_length + 1).keys()]
                    },
                    {
                        show: false,
                        type: "slider"
                    }
                ]
                });
            }
            else{
                chart.setOption({
                    dataZoom: [
                    {
                        type: "inside",
                        filterMode: 'none',
                        xAxisIndex: [...Array(gird_index_length + 1).keys()]
                    },
                    {
                        show: true,
                        filterMode: 'none',
                        xAxisIndex: [...Array(gird_index_length + 1).keys()],
                        type: "slider"
                    }
                ]
                });
            } 
        }
        
        function setYMax(){
            var ymax = document.getElementById('ymax').value;
            var yaxis_option = chart.getOption().yAxis;
            for(let i = 0 ; i < gird_index_length; i++){
                yaxis_option[i].max = ymax
            }
            chart.setOption({yAxis: yaxis_option})
        }


        chart.on('click', function(params){
            document.getElementById('start_pos').value = params.value[1]
            document.getElementById('end_pos').value = params.value[2]
            chart.dispatchAction({
                type:'dataZoom',
                startValue: params.value[1],
                endValue: params.value[2]
            })
        })
        
        chart.on('dblclick', function(params){
            document.getElementById('start_pos').value = 1
            document.getElementById('end_pos').value = ref_len
            chart.dispatchAction({
                type:'dataZoom',
                start: 0,
                end: 100
            })
        })

        function updateOption(samples){   
            
            var origin_depths = {{ depth_data }};
            var origin_variants = {{ variant_data }};

            var depths = []
            var variants = []

            for (const selected_samples of samples){
                depths.push(origin_depths[selected_samples])
                variants.push(origin_variants[selected_samples])
            }
            gird_index_length = samples.length
            var options = {
                title: {
                },
                dataset: getDatasets(depths, positions),
                xAxis: getXAxes(samples, ref_len),
                yAxis: getYAxes(samples, "log", 100000),
                series: [...getDepthSeries(samples),...getVariantsSeries(variants, depths), ...getGeneFeatureSeries(gird_index_length)],
                tooltip: getTooltips(samples, depths, variants),
                toolbox: {
                    show: "true",
                    feature: {
                        dataView: {
                            readOnly: false
                        },
                        restore: {},
                        saveAsImage: {
                            name: "Coverage_Plot"
                        }
                    }
                },
                dataZoom: [
                    {
                        type: "inside",
                        filterMode: 'none',
                        xAxisIndex: [...Array(gird_index_length + 1).keys()]
                    },
                    {
                        show: true,
                        filterMode: 'none',
                        xAxisIndex: [...Array(gird_index_length + 1).keys()],
                        type: "slider"
                    }
                ],
                grid: getGrids(samples)
            };
            chart.setOption(option = options, notMerge = true);
        }


        function updateChartDivSize() {
          var BOTTOM_PADDING = 20;
          var top = $chart.getBoundingClientRect().top;
          var height = window.innerHeight - top - BOTTOM_PADDING;
          if (height < 300) {
            height = 300;
          }
          $chart.style.height = height + 'px';
          chart.resize();
        }

        window.addEventListener("resize", updateChartDivSize);
        document.addEventListener("DOMContentLoaded", function(event) {
            updateChartDivSize();
            chart.resize();
        })

        chart.setOption(option = getOption());

        $(document).ready(function() {
            $('.selected-samples').select2();
            $(".selected-samples").on("change", function (e) {
                var selectData = $(".selected-samples").select2("data");
                var samples_list = []
                for (var [key, entries] of selectData.entries()){
                   samples_list.push(selectData[key].text)
                }
                updateOption(samples_list)
            });
        });

        $("select").select2({
            tags: true
        });

        $("select").on("select2:select", function (evt) {
            var element = evt.params.data.element;
            var $element = $(element);
            
            $element.detach();
            $(this).append($element);
            $(this).trigger("change");
        });

        function setDataZoom(){
            var start = document.getElementById('start_pos').value
            var end = document.getElementById('end_pos').value
            chart.dispatchAction({
                type:'dataZoom',
                startValue: start,
                endValue: end
            })
        }

        function resetDataZoom(){
            document.getElementById('start_pos').value = 1 
            document.getElementById('end_pos').value = ref_len
            chart.dispatchAction({
                type:'dataZoom',
                start: 0,
                end: 100
            })
        }

    </script>
</body>
</html>