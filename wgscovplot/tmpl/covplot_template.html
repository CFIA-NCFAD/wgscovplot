<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WGS Coverage Plot</title>
    <style>{{ bootstrap_css }}</style>
    <script>{{ jquery_js }}</script>
    <script>{{ bootstrap_js }}</script>
    <script>{{ echarts_js }}</script>
    <style>{{ select2_css }}</style>
    <script>{{ select2_js }}</script>
    <style>
        
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 5px 16px;
            transition: 0.3s;
        }

        .tab button:hover {
            background-color: #ddd;
        }

        .tab button.active {
            background-color: #ccc;
        }

        .chart-container {
            display: none;
            padding: 6px 12px;
        }

        #table_id {
            font-family: Arial, Helvetica, sans-serif;
            border-collapse: collapse;
            padding-top: 1%;
            width: 100%;
        }

        #table_id td, #table_id th {
            border: 1px solid #ddd;
            padding: 8px;
        }

        #table_id tr:nth-child(even){
            background-color: #f2f2f2;
        }

        #table_id tr:hover {
            background-color: #ddd;
        }

        #table_id tr {
            justify-content: space-between;
        }

        #table_id th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #04AA6D;
            color: white;
            justify-content: space-between;
        }

        h2 {
            margin:0px auto;
            padding: 10px 0px 10px 0px;
            border-bottom: 2px ridge;
        }

        table {
            border-collapse: collapse;
        }

        th, td {
           border: 1px solid black;
        }

    </style>
</head>
<body>
    <div class="tab">
        <button class="tablinks" data-bs-toggle="offcanvas" data-bs-target="#controlmenu">â˜° Chart Options</button>
        <button class="tablinks" onclick="showChart(event,'chart')">Coverage Plot</button>
        <button class="tablinks" onclick="showChart(event,'table_id')">Summary Information</button>
        <button class="tablinks" onclick="showChart(event,'fqa_id')">FQA</button>
        <button class="tablinks" onclick="showChart(event,'about_id')">About</button>
    </div>

    <div id="chart" class="chart-container" style="width:100%; height: 900px;"></div>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="controlmenu">

        <div class="offcanvas-header">
            <h5>Chart Options</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close" aria-labelledby="controlmenu"></button>
        </div>

        <div class="offcanvas-body">
            <div class="accordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#general" aria-expanded="true" aria-controls="general">
                            General   
                        </button>
                    </h2>
                <div id="general" class="accordion-collapse collapse show">
                    <div class="accordion-body">
                        <label for="samples">Samples:</label>
                        <select class="selected-samples" multiple="multiple" style="width: 75%" >
                            {% for id, sample in samples_name.items() %}
                                <option value={{sample}}>{{sample}}</option>
                            {% endfor %}
                        </select>
                    </div>
                  </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#axis" aria-expanded="false" aria-controls="axis">
                            Axis
                        </button>
                    </h2>
                    <div id="axis" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <p>Scale:  
                                <select id="scale" onchange="setScale()" style="width: 25%">
                                    <option value="value" >Linear</option>
                                    <option value="log" selected>Log</option>
                                </select>
                            </p>
                            <p> 
                                <form id="ymaxform">
                                    <label for="ymaxform">yMax: </label>
                                    <input type="number" id="ymax" value=100000 style="width: 30%">
                                    <input type="button" onclick="setYMax()" value="Set yMax">
                                </form>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tooltip" aria-expanded="false" aria-controls="tooltip">
                            Tooltip
                        </button>
                    </h2>
                    <div id="tooltip" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <p>Show Tooltip:  
                                <select id="showtooltip" onchange="tooltipOption()" style="width: 25%">
                                    <option value="false" >Disable</option>
                                    <option value="true" selected>Enable</option>
                                </select>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#datazoom" aria-expanded="false" aria-controls="datazoom">
                            Data Zoom
                        </button>
                    </h2>
                    <div id="datazoom" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <p>Show Slider:  
                                <select id="showslider" onchange="dataZoomOption()" style="width: 25%">
                                    <option value="true" selected>Enable</option>
                                    <option value="false">Disable</option>
                                </select>
                            </p>
                            <form id="dataZoom">
                                <label for="start_pos">Start Pos:</label><br>
                                <input type="number" id="start_pos" value=1><br>
                                <label for="start_pos">End Pos:</label><br>
                                <input type="number" id="end_pos" value={{ref_seq_length}}><br><br>
                                <input type="button" onclick="setDataZoom()" value="Set DataZoom">
                                <input type="button" onclick="resetDataZoom()" value="Reset DataZoom">
                            </form>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#genefeatures" aria-expanded="false" aria-controls="genefeatures">
                            Gene Features
                        </button>
                    </h2>
                    <div id="genefeatures" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <p>Show Gene Label:  
                                <select id="genelabel" onchange="geneLabel()" style="width: 25%">
                                    <option value="true" selected>True</option>
                                    <option value="false" >False</option>
                                </select>
                            </p>
                            <p>Grid Height:  
                                <input type="range" value="15" min="1" max="50"  onchange="updateTextInput(this.value);">
                                <output type="text" id="textInput">15</output>
                                <output>%</output>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="about_id" class="chart-container">
        {{ about_html }}
    </div>

    <div id="fqa_id" class="chart-container">
        <h4>What happens when the number of samples shown on the chart changed?</h4>
        <ul>
            <li>By the default, at first up to 3 first samples are selected for displaying on the charts</li>
            <li>The entire chart will be re-rendered if you select/change samples to be displayed and you need to set your chart options again, changing other options will not re-render the entire chart</li>
        </ul>

        <h4>What happens when browser zoom is set more than 100%?</h4>
        <ul>
            <li>Some minor graphic (such as some items get cut off) issues may happen. To fix this type of issue, try to adjust browser zoom and this may allow you to have better view</li>
        </ul>

        <h4>How many simultaneous samples are on the chart for the best view?</h4>
        <ul>
            <li>It is recommended that having around 5 simultaneous samples on the chart for the best view</li>
        </ul>

        <h4>What will you do when the plot is distorted or minimized?</h4>
        <ul>
            <li>This issue could happen when you shrink and maximize browser, to restore plot display just simply refresh browser</li>
        </ul>
    </div>
    <table id="table_id" class="chart-container">
        <tr>
            <th>Sample Name</th>
            <th>Mean Coverage</th>
            <th>Median Coverage</th>
            <th>Genome Coverage(>= 10x)</th>
            <th>Low Coverage Positions (< 10X) </th>
            <th>No Coverage Positions (0X)</th>
            <th>Low Coverage Regions (< 10X)</th>
            <th>No Coverage Regions (0X)</th>
        </tr>
        {% for data_info in coverage_stat %}
            <tr>
                <td>{{ data_info[0] }}</td>
                <td>{{ data_info[1] }}</td>
                <td>{{ data_info[2] }}</td>
                <td>{{ data_info[3] }}</td>
                <td>{{ data_info[4] }}</td>
                <td>{{ data_info[5] }}</td>
                <td>{{ data_info[6] }}</td>
                <td>{{ data_info[7] }}</td>
            </tr>
        {% endfor %}
    </table>

    <script>
        window.ref_seq = "{{ ref_seq }}";
        window.samples = {{ samples_name }}
        window.depths = {{ depth_data }};
        window.variants = {{ variant_data }};
    </script>

    <script>
        (function() {
            containers = document.getElementsByClassName("chart-container");
            if(containers.length > 0) {
                containers[0].style.display = "block";
            }
        })()

        function showChart(evt, chartID) {
            let containers = document.getElementsByClassName("chart-container");
            for (let i = 0; i < containers.length; i++) {
                    containers[i].style.display = "none";
            }

            let tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = "tablinks";
            }

            document.getElementById(chartID).style.display = "block";
            evt.currentTarget.className += " active";
        }
    </script>


    <script>
        var ref_len = window.ref_seq.length;
        var gene_features_properties = {{ gene_features_properties }}
        var grid_length;
        var positions = [...Array(ref_len + 1).keys()];
        positions.shift();

        var ntColor = {
            "A": "#F00",
            "C": "#0F0",
            "G": "#00F",
            "T": "#0FF",
        }

        //window.depths = depths;
        var $chart = document.getElementById('chart');
        window.$chart = $chart;
        var chart = echarts.init($chart, 'white', {renderer: 'canvas'});
        window.chart = chart;


        /////////////// Define Gene Feature /////////////////////
        var gene_feature  = {{ gene_feature }}
        var y_start;
        function renderGeneFeatures(params, api){
            var categoryIndex = api.value(0);
            var start = api.coord([api.value(1), categoryIndex]);
            var points;
            var shape;
            var rotate_angle;
            if (categoryIndex==0){
                y_start = start[1]
            }
            var end = api.coord([api.value(2), categoryIndex]);
            var height = gene_features_properties['rec_items_height'];
            var width = end[0] - start[0] ;
            var x = start[0];
            var y = y_start - height/2  - api.value(3);

            if (api.value(4) == 1){ 
                /* 5 Points of shape of + strand
                ----------------------
                |                      \
                |                      /
                ----------------------                
                */
                points = [
                    [x, y],
                    [x + width - width/100 , y],
                    [x + width , y - height / 2 ],
                    [x + width - width/100 , y - height ],
                    [x, y - height ]
                ]
                rotate_angle = 0.7;
            }
            else {
                /* 5 Points of shape - strand
                  -----------------------
                /                       |                    
                \                       |
                  -----------------------                
                */
                points = [
                    [x, y - height/2],
                    [x + width/100, y],
                    [x + width, y],
                    [x + width, y - height],
                    [x + width/100, y - height]
                ]
                rotate_angle = -0.7;
            }
            shape = echarts.graphic.clipPointsByRect(points,
                {
                    x: params.coordSys.x,
                    y: params.coordSys.y,
                    width: params.coordSys.width,
                    height: params.coordSys.height
            });
            return {
                type: 'polygon',
                shape: {
                    points: shape
                },
                style : api.style({}),
                textContent: {
                    type: 'text',
                    invisible: false,
                    style: {
                        text: gene_feature[categoryIndex].name,
                        fill: gene_feature[categoryIndex].itemStyle.color,
                        fontStyle: 'normal',
                        fontSize: 10,
                        fontWeight: 'bolder'
                    }
                },
                textConfig:{
                    position: 'top',
                    distance: 20,
                    rotation: rotate_angle,
                    local: true
                }
            };
        }

        function getGeneFeatureSeries(index){
            var feature_series =[]
            feature_series.push({
                type: "custom",
                xAxisIndex: index,
                yAxisIndex: index,
                renderItem:renderGeneFeatures,
                data: gene_feature,
                tooltip:{
                    trigger: "item",
                    enterable: true,
                    appendToBody: true,
                    renderMode: "html",
                    borderRadius: 6,
                    borderWidth: 2,
                    showContent: "true",
                    textStyle: {
                        fontSize: 15,
                        fontWeight: "bolder"
                    },
                    formatter: function (params){
                        var output = ''
                        output += params.name + '<br/>' + 'Start pos: ' + params.value[1].toLocaleString() + '<br/>' + 'End pos: ' + params.value[2].toLocaleString() + '<br/>' + 'Length: ' + (params.value[2] - params.value[1] + 1).toLocaleString() + '<br/>' + 'Strand: ' + (params.value[4]).toLocaleString()
                        return output
                    }
                }
            })
            return feature_series
        }
        ///////////////////// End of Gene Feature/////////////////////

        function getXAxes(samples, ref_len) {
            var axes = [];
            for (var [i, sample] of samples.entries()) {
                axes.push({
                    type: "value",
                    gridIndex: i,
                    min: 1,
                    max: ref_len,
                    axisLabel: {
                        interval: "auto",
                    }
                });
            }
            axes.push({
                    type: "value",
                    gridIndex: samples.length,
                    min: 1,
                    max: ref_len,
                    axisLabel: {
                        interval: "auto"
                    } 
            })
            return axes;
        }

        function getYAxes(samples, scaletype, ymax) {
            var axes = [];
            for (var [i, sample] of samples.entries()) {
                axes.push({
                    type: scaletype,
                    gridIndex: i,
                    name: sample,
                    nameTextStyle: {
                        fontStyle: "normal",
                        fontWeight: "bolder"
                    },
                    nameLocation: "end",
                    min: 1,
                    max: ymax,
                    minorSplitLine: { 
                        show: true
                    }
                });
            }
            axes.push({
                max: gene_features_properties['max_grid_height'],
                gridIndex: samples.length,
                show: false
            })
            return axes;
        }

        function getDatasets(depths, positions) {
            var datasets = [];
            for (var [i, depthArray] of depths.entries()) {
                datasets.push({
                    dimensions: [
                        {name : "depth", type: "int"},
                        {name: "position", type: "int"}
                    ],
                    source: {
                        position: positions,
                        depth: depthArray
                    }
                });
            }
            return datasets;
        }

        function getDepthSeries(samples) {
            var series = []
            for (var [i, sample] of samples.entries()) {
                series.push({
                    type: "line",
                    xAxisIndex: i,
                    yAxisIndex: i,
                    areaStyle: {
                        color: '#666'
                    },
                    encode: {
                        x: "position",
                        y: "depth",
                    },
                    symbol: "none",
                    datasetIndex: i,
                    lineStyle: {
                        color: '#666',
                        opacity: 0
                    },
                    large: true,
                })
            }
            return series
        }

        function getVariantsSeries(variants, depths) {
            var series = []
            for (var [i, varMap] of variants.entries()) {
                (function(i, varMap) {
                    series.push({
                        type: "bar",
                        xAxisIndex: i,
                        yAxisIndex: i,
                        data: Object.keys(varMap).map((x) => [parseInt(x), depths[i][x]]),
                        barWidth: 2,
                        itemStyle: {
                            color: function (params) {
                                var pos = params.data[0];
                                var nt = variants[i][pos]
                                if (ntColor.hasOwnProperty(nt[0][0])) {
                                    return ntColor[nt[0][0]]
                                } //else {
                                    //console.log(variants.length, pos, i)
                                //}
                                return "#333";
                            }
                        }
                    })
                })(i, varMap);
            }
            return series
        }

        function getGrids(samples) {
            var n = samples.length + 1;
            var last_height;
            var last_top;
            var grids = Object.keys(samples).map(function (sample) {
                last_height = (1 / n * 100) - 6
                if (n == 2){ // Only 1 sample (1 sample + gene feature plot)
                    last_height = 70
                    return {
                        "show": true,
                        "height": "70%" // plot display in nearly full scale
                    };
                }
                return {
                    "show": true,
                    "height": (1 / n * 100) - 6 + "%"
                };
            });
            grids.forEach(function (grid, idx) {
                //var padTop = idx === 1 ? 5 : 3
                var padTop = 4
                last_top = (idx / n * 100) + padTop
                grid.top = (idx / n * 100) + padTop + "%"
            })
            grids.push({
                show: true,
                height: gene_features_properties['grid_height'],
                top: last_height + last_top + 3 + "%"
            })
            return grids
        }

        function meanCoverage(depths, start, end, gridIndex) {
            var total = 0;
            if (start < end){
                for (var i = start - 1; i <= end - 1; i++){
                    total +=  depths[gridIndex][i]
                }
                return total/(end-start+1)
            }
            else if (start == end){
                return depths[gridIndex][start]
            }
        }

        function genomeCoverage(depths, start, end, gridIndex, low) {
            var total = 0;
            for (var i = start - 1; i <= end - 1; i++){
                if (depths[gridIndex][i] >= low){
                    total += 1
                }
            }
            return total/(end-start+1) * 100
        }

        function median(arr) {
            arr.sort( function(a,b) {return a - b;} );
            var half = Math.floor(arr.length/2);
            if(arr.length % 2)
                return arr[half];
            else
                return (arr[half-1] + arr[half]) / 2.0;
        }

        function medianCoverage(depths, start, end, gridIndex) {
            var sub_array = depths[gridIndex].slice(start-1, end)
            return median(sub_array)
        }

        function getTooltips(samples, depths, variants){
            return [{
                trigger: "axis",
                enterable: true,
                appendToBody: true,
                renderMode: "html",
                showContent: true,
                formatter: function (params) {
                    var output = "";
                    var param = params[0];
                    var i = param.axisIndex;
                    var position = param.data[1];
                    if (i < samples.length){
                        var sample = samples[i];
                        var depth = param.data[0];
                        var start_pos, end_pos;
                        start_pos = Math.floor(chart.getOption().dataZoom[0].startValue)
                        end_pos = Math.floor(chart.getOption().dataZoom[0].endValue)
                        var mean_cov;
                        mean_cov = meanCoverage(depths, start_pos, end_pos, i).toFixed(2);
                        var median_cov;
                        median_cov = medianCoverage(depths, start_pos, end_pos, i).toFixed(2);
                        var genome_cov;
                        genome_cov = genomeCoverage(depths, start_pos, end_pos, i, 10).toFixed(2)
                        output += "<b>" + sample + "</b><br/>" + 'Start pos: ' + start_pos.toLocaleString() + '<br/>' + 'End pos: ' + end_pos.toLocaleString() + '<br/>';
                        output += 'Mean Coverage: ' + mean_cov + 'X' + '<br/>';
                        output += 'Median Coverage: ' + median_cov + 'X' + '<br/>';
                        output += 'Genome Coverage ( >= 10x): ' + genome_cov + '%' + '<br/>';
                        output += 'Position: ' + position.toLocaleString() + '<br/> Coverage Depth: ' + depth.toLocaleString() + '<br/>';
                        
                        if (variants[i].hasOwnProperty(position)){
                            output += 'Ref: ' + ref_seq.substring(position - 1, position - 1 + variants[i][position].length) + '<br/>'
                            output = output + 'Variant: ' + variants[i][position]
                        }
                        else{
                            output += 'Ref: ' + ref_seq[position-1] + '<br/>'
                        }
                        return output;
                    }
                    return output
                }
            }] 
        }

        function getOption(){

            var default_num_chart = 3; // At the beginning display maximum 3 samples
            var samples = [];
            var depths = []
            var variants = []

            for (const [key, entries] of Object.entries(window.samples)){
                if (key < default_num_chart){
                    samples.push(entries)
                    depths.push(window.depths[entries])
                    variants.push(window.variants[entries])
                }
            }
            grid_length = samples.length
            var options = {
                title: {
                },
                dataset: getDatasets(depths, positions),
                xAxis: getXAxes(samples, ref_len),
                yAxis: getYAxes(samples, "log", 100000),
                series: [...getDepthSeries(samples),...getVariantsSeries(variants, depths), ...getGeneFeatureSeries(grid_length)],
                tooltip: getTooltips(samples, depths, variants),
                toolbox: {
                    show: "true",
                    feature: {
                        dataView: {
                            readOnly: false
                        },
                        restore: {},
                        saveAsImage: {
                            name: "Coverage_Plot"
                        }
                    }
                },
                dataZoom: [
                    {
                        type: "inside",
                        filterMode: 'none',
                        xAxisIndex: [...Array(grid_length + 1).keys()],
                        zoomLock: false
                    },
                    {
                        show: true,
                        filterMode: 'none',
                        xAxisIndex: [...Array(grid_length + 1).keys()],
                        type: "slider",
                        zoomLock: false
                    }
                ],
                grid: getGrids(samples)
            };
            return options
        }

        function tooltipOption(){
            var tooltipx = document.getElementById('showtooltip').value;
            if (tooltipx=='false'){
                chart.setOption({
                    tooltip:{showContent: false}
                });
            }
            else{
                chart.setOption({
                    tooltip:{showContent: true}
                });
            }
        }

        function setScale(){
            var scaletype = document.getElementById('scale').value;
            var yaxis_option = chart.getOption().yAxis;
            if (scaletype == 'value'){
                for(let i = 0 ; i < grid_length; i++){
                    yaxis_option[i].type = scaletype
                    yaxis_option[i].min = 0
                    yaxis_option[i].max = 40000
                }
                chart.setOption({yAxis: yaxis_option})
                document.getElementById('ymax').value = 40000
            }
            else{
                for(let i = 0 ; i < grid_length; i++){
                    yaxis_option[i].type = scaletype
                    yaxis_option[i].min = 1
                    yaxis_option[i].max = 100000
                }
                chart.setOption({yAxis: yaxis_option})
                document.getElementById('ymax').value = 100000
            }
        }

        function updateGeneFeatures(params, api){
            var categoryIndex = api.value(0);
            var start = api.coord([api.value(1), categoryIndex]);
            var points;
            var shape;
            var rotate_angle;
            if (categoryIndex==0){
                y_start = start[1]
            }
            var end = api.coord([api.value(2), categoryIndex]);
            var height = gene_features_properties['rec_items_height'];
            var width = end[0] - start[0] ;
            var x = start[0];
            var y = y_start - height/2  - api.value(3);

            if (api.value(4) == 1){ 
                /* 5 Points of shape of + strand
                ----------------------
                |                      \
                |                      /
                ----------------------                
                */
                points = [
                    [x, y],
                    [x + width - width/100 , y],
                    [x + width , y - height / 2 ],
                    [x + width - width/100 , y - height ],
                    [x, y - height ]
                ]
                rotate_angle = 0.7;
            }
            else {
                /* 5 Points of shape - strand
                  -----------------------
                /                       |                    
                \                       |
                  -----------------------                
                */
                points = [
                    [x, y - height/2],
                    [x + width/100, y],
                    [x + width, y],
                    [x + width, y - height],
                    [x + width/100, y - height]
                ]
                rotate_angle = -0.7;
            }
            shape = echarts.graphic.clipPointsByRect(points,
                {
                    x: params.coordSys.x,
                    y: params.coordSys.y,
                    width: params.coordSys.width,
                    height: params.coordSys.height
            });
            return {
                type: 'polygon',
                shape: {
                    points: shape
                },
                style : api.style({}),
                textContent: {
                    type: 'text',
                    invisible: true,
                },
            };
        }

        function geneLabel(){
            var hideoverlap = document.getElementById('genelabel').value;
            var series_option = chart.getOption().series;
            gene_features_grid_index = series_option.length - 1
            if (hideoverlap=='false'){
                series_option[gene_features_grid_index]['renderItem'] = updateGeneFeatures
                chart.setOption({series: [...series_option]})
            }
            else{
                series_option[gene_features_grid_index]['renderItem'] = renderGeneFeatures
                chart.setOption({series: [...series_option]})
            }
        }

        function updateTextInput(val) {
            document.getElementById('textInput').value=val; 
            var grid_option = chart.getOption().grid;
            gene_features_grid_index = grid_option.length - 1
            grid_option[gene_features_grid_index]['height'] = val +'%'
            chart.setOption({grid:grid_option})
        }

        function dataZoomOption(){
            var sliderx = document.getElementById('showslider').value;
            if (sliderx=="false"){
                chart.setOption({
                    dataZoom: [
                    {
                        type: "inside",
                        filterMode: 'none',
                        xAxisIndex: [...Array(grid_length + 1).keys()]
                    },
                    {
                        show: false,
                        type: "slider"
                    }
                ]
                });
            }
            else{
                chart.setOption({
                    dataZoom: [
                    {
                        type: "inside",
                        filterMode: 'none',
                        xAxisIndex: [...Array(grid_length + 1).keys()]
                    },
                    {
                        show: true,
                        filterMode: 'none',
                        xAxisIndex: [...Array(grid_length + 1).keys()],
                        type: "slider"
                    }
                ]
                });
            } 
        }
        
        function setYMax(){
            var ymax = document.getElementById('ymax').value;
            var yaxis_option = chart.getOption().yAxis;
            for(let i = 0 ; i < grid_length; i++){
                yaxis_option[i].max = ymax
            }
            chart.setOption({yAxis: yaxis_option})
        }


        chart.on('click', function(params){
            document.getElementById('start_pos').value = params.value[1]
            document.getElementById('end_pos').value = params.value[2]
            chart.dispatchAction({
                type:'dataZoom',
                startValue: params.value[1],
                endValue: params.value[2]
            })
        })
        
        chart.on('dblclick', function(params){
            document.getElementById('start_pos').value = 1
            document.getElementById('end_pos').value = ref_len
            chart.dispatchAction({
                type:'dataZoom',
                start: 0,
                end: 100
            })
        })

        function updateOption(samples){   
            
            var depths = []
            var variants = []

            for (const selected_samples of samples){
                depths.push(window.depths[selected_samples])
                variants.push(window.variants[selected_samples])
            }
            grid_length = samples.length
            var options = {
                title: {
                },
                dataset: getDatasets(depths, positions),
                xAxis: getXAxes(samples, ref_len),
                yAxis: getYAxes(samples, "log", 100000),
                series: [...getDepthSeries(samples),...getVariantsSeries(variants, depths), ...getGeneFeatureSeries(grid_length)],
                tooltip: getTooltips(samples, depths, variants),
                toolbox: {
                    show: "true",
                    feature: {
                        dataView: {
                            readOnly: false
                        },
                        restore: {},
                        saveAsImage: {
                            name: "Coverage_Plot"
                        }
                    }
                },
                dataZoom: [
                    {
                        type: "inside",
                        filterMode: 'none',
                        xAxisIndex: [...Array(grid_length + 1).keys()]
                    },
                    {
                        show: true,
                        filterMode: 'none',
                        xAxisIndex: [...Array(grid_length + 1).keys()],
                        type: "slider"
                    }
                ],
                grid: getGrids(samples)
            };
            chart.setOption(option = options, notMerge = true);
        }


        function updateChartDivSize() {
          var BOTTOM_PADDING = 20;
          var top = $chart.getBoundingClientRect().top;
          var height = window.innerHeight - top - BOTTOM_PADDING;
          if (height < 300) {
            height = 300;
          }
          $chart.style.height = height + 'px';
          chart.resize();
        }

        window.addEventListener("resize", updateChartDivSize);
        document.addEventListener("DOMContentLoaded", function(event) {
            updateChartDivSize();
            chart.resize();
        })

        chart.setOption(option = getOption());

        $(document).ready(function() {
            $('.selected-samples').select2();
            $(".selected-samples").on("change", function (e) {
                var selectData = $(".selected-samples").select2("data");
                var samples_list = []
                for (var [key, entries] of selectData.entries()){
                   samples_list.push(selectData[key].text)
                }
                updateOption(samples_list)
            });
        });

        $("select").select2({
            tags: true
        });

        $("select").on("select2:select", function (evt) {
            var element = evt.params.data.element;
            var $element = $(element);
            
            $element.detach();
            $(this).append($element);
            $(this).trigger("change");
        });

        function setDataZoom(){
            var start = document.getElementById('start_pos').value
            var end = document.getElementById('end_pos').value
            chart.dispatchAction({
                type:'dataZoom',
                startValue: start,
                endValue: end
            })
        }

        function resetDataZoom(){
            document.getElementById('start_pos').value = 1 
            document.getElementById('end_pos').value = ref_len
            chart.dispatchAction({
                type:'dataZoom',
                start: 0,
                end: 100
            })
        }

    </script>
</body>
</html>