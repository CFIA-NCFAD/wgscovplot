<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive Coverage Plot</title>
    <script type="text/javascript" src="{{ echarts_js }}"></script>
</head>
<body>
    <div id="chart" class="chart-container" style="width:100%; height:1200px;"></div>
    <script>
        var ref_seq = "{{ ref_seq }}";
        var samples = {{ samples_name }}
        var ref_len = ref_seq.length;
        var depths = {{ depth_data }};
        var mean = [ 1002, 2036, 5623, 8956, 5623, 5463]
        // create array from range 0 to (ref_len + 1)
        var positions = [...Array(ref_len + 1).keys()];
        // remove zero
        positions.shift();

        //var maxDepth = Math.max(...depths.flat());
        window.depths = depths;
        var $chart = document.getElementById('chart');
        window.$chart = $chart;
        var chart = echarts.init($chart, 'white', {renderer: 'canvas'});
        window.chart = chart;

        function getXAxes(samples, ref_len) {
            var axes = [];
            for (var [i, sample] of samples.entries()) {
                axes.push({
                    "type": "value",
                    "gridIndex": i,
                    "min": 1,
                    "max": ref_len,
                    "axisLabel": {
                        "interval": "auto"
                    }
                });
            }
            return axes;
        }

        function getYAxes(samples) {
            var axes = [];
            for (var [i, sample] of samples.entries()) {
                axes.push({
                    "type": "log",
                    "gridIndex": i,
                    "name": sample,
                    "nameTextStyle": {
                        "fontStyle": "normal",
                        "fontWeight": "bolder"
                    },
                    "nameLocation": "end",
                    "min": 1,
                    "max": 100000,
                    "minorSplitLine": { "show": true}
                });
            }
            return axes;
        }

        function getDatasets(depths, positions) {
            var datasets = [];
            for (var [i, depthArray] of depths.entries()) {
                datasets.push({
                    "dimensions": [
                        {"name" : "depth", "type": "int"},
                        {"name": "position", "type": "int"}
                    ],
                    "source": {
                        "position": positions,
                        "depth": depthArray
                    }
                });
            }
            return datasets;
        }

        function getDepthSeries(samples) {
            var series = []
            for (var [i, sample] of samples.entries()) {
                series.push({
                    "type": "line",
                    "xAxisIndex": i,
                    "yAxisIndex": i,
                    "areaStyle": {
                        "color": '#666'
                    },
                    "encode": {
                        "x": "position",
                        "y": "depth",
                    },
                    "symbol": "none",
                    "datasetIndex": i,
                    "lineStyle": {
                        "color": '#666',
                        "opacity": 0
                    },
                    "large": true
                })
            }
            return series
        }

        var variants = {{ variant_data }}
        window.variants = variants;

        var ntColor = {
            "A": "#F00",
            "C": "#0F0",
            "G": "#00F",
            "T": "#0FF",
        }


        function getVariantsSeries(variants, depths) {
            // var vars = JSON.parse(JSON.stringify(variants))
            var series = []
            for (var [i, varMap] of variants.entries()) {
                (function(i, varMap) {
                    series.push({
                        "type": "bar",
                        "xAxisIndex": i,
                        "yAxisIndex": i,
                        "data": Object.keys(varMap).map((x) => [parseInt(x), depths[i][x]]),
                        "barWidth": 2,
                        "itemStyle": {
                            "color": function (params) {
                                var pos = params.data[0];
                                var nt = variants[i][pos]
                                if (ntColor.hasOwnProperty(nt[0][0])) {
                                    return ntColor[nt[0][0]]
                                } //else {
                                    //console.log(variants.length, pos, i)
                                //}
                                return "#333";
                            }
                        }
                    })
                })(i, varMap);
            }
            return series
        }

        function getGrids(samples) {
            var n = samples.length;
            var grids = Object.keys(samples).map(function (sample) {
                return {
                    "show": true,
                    "height": (1 / n * 100) - 10 + "%"
                };
            });
            grids.forEach(function (grid, idx) {
                var padTop = idx === 0 ? 5 : 2
                grid.top = (idx / n * 100) + padTop + "%"
            })
            //console.log(grids)
            return grids
        }
        function meanCoverage(depths, start, end, gridIndex) {
               var total = 0;
               if (start < end){
                   for (var i = start- 1; i <= end - 1; i++){
                       total +=  depths[gridIndex][i]
                   }
                   return total/(end-start+1)
               }
               else if (start == end){
                    return depths[gridIndex][start]
               }
        }

        function median(arr) {
            arr.sort( function(a,b) {return a - b;} );
            var half = Math.floor(arr.length/2);
            if(arr.length % 2)
                return arr[half];
            else
                return (arr[half-1] + arr[half]) / 2.0;
        }

        function medianCoverage(depths, start, end, gridIndex) {
           var sub_array = depths[gridIndex].slice(start-1, end).sort()
           return median(sub_array)
        }

        var options = {
            "title": {
                "text": "Coverage Plot",
                "textAlign": "center",
                "left": "45%"
            },
            "dataset": getDatasets(depths, positions),
            "xAxis": getXAxes(samples, ref_len),
            "yAxis": getYAxes(samples),
            "series": [...getDepthSeries(samples), ...getVariantsSeries(variants, depths)],
            "tooltip": {
                "trigger": "axis",
                "formatter": function (params) {
                    var output = "";
                    //console.log(params);
                    if (params.length > 1) {
                        console.log(params)
                    }
                    var param = params[0];
                    var i = param.axisIndex;
                    var sample = samples[i];
                    var depth = param.data[0];
                    var position = param.data[1];
                    var st = [];
                    var start_pos, end_pos;
                    start_pos = Math.ceil(chart.getOption().dataZoom[0].start * ref_len / 100);
                    if (start_pos == 0){
                        start_pos = 1;
                    }
                    end_pos = Math.ceil(chart.getOption().dataZoom[0].end * ref_len / 100);
                    var mean_cov;
                    mean_cov = meanCoverage(depths, start_pos, end_pos, i).toFixed(2);
                    var median_cov;
                    median_cov = medianCoverage(depths, start_pos, end_pos, i).toFixed(2);
                    output += "<b>" + sample + "</b><br/>" + 'Start pos: ' + start_pos+ '<br/>' + 'End pos: ' + end_pos + '<br/>';
                    output += 'Mean Coverage: ' + mean_cov + 'X' + '<br/>';
                    output += 'Median Coverage: ' + median_cov + 'X' + '<br/>';
                    output += 'Position: ' + position + '<br/> Coverage Depth: ' + depth + '<br/>';
                    if (variants[i].hasOwnProperty(position)){
                        output += 'Ref: ' + ref_seq.substring(position-1, position-1 + variants[i][position][0].length) + '<br/>'
                    }
                    else{
                        output += 'Ref: ' + ref_seq[position-1] + '<br/>'
                    }
                    if (variants[i].hasOwnProperty(position)) {
                        //console.log(variants[i][position]);
                        output = output + 'Variant: ' + variants[i][position][1]
                    }

                    return output;
                }
            },
            "brush": {},
            "toolbox": {
                "show": "true",
                "feature": {
                    "dataZoom": {
                        "yAxisIndex": [0]
                    },
                    "dataView": {
                        "readOnly": "false"
                    },
                    "restore": {},
                    "saveAsImage": {
                        "name": "Coverage_Plot"
                    }
                }
            },
            "dataZoom": [
                {
                    "type": "inside",
                    "xAxisIndex": [...samples.keys()]
                },
                {
                    "type": "inside",
                    "xAxisIndex": [...samples.keys()]
                },
                {
                    "show": "true",
                    "xAxisIndex": [...samples.keys()],
                    "type": "slider"
                }
            ],
            "grid": getGrids(samples)
        };

        window.options = options;
        chart.setOption(options);
        function updateChartDivSize() {
          var BOTTOM_PADDING = 20;
          var top = $chart.getBoundingClientRect().top;
          var height = window.innerHeight - top - BOTTOM_PADDING;
          if (height < 300) {
            height = 300;
          }
          $chart.style.height = height + 'px';
          chart.resize();
        }

        window.addEventListener("resize", updateChartDivSize);
        document.addEventListener("DOMContentLoaded", function(event) {
            updateChartDivSize();
            chart.resize();
        })
    </script>
</body>
</html>