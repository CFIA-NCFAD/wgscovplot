<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive Coverage Plot</title>
    <script type="text/javascript" src="{{ echarts_js }}"></script>
</head>
<body>

    <div class="tab">
        <button class="tablinks" onclick="showChart(event,'chart')">Coverage Plot</button>
        <button class="tablinks" onclick="showChart(event,'table_id')">Summary Information</button>
    </div>

    <div id="chart" class="chart-container" style="width:100%; height:1500px;"></div>

    <table id="table_id" class="chart-container">
        <tr>
            <th>Sample Name</th>
            <th>Mean Covearge</th>
            <th>Median Covearge</th>
            <th>Genome Coverage(>= 10x)</th>
            <th>Low Coverage Positions (< 10X) </th>
            <th>No Coverage Positions (0X)</th>
            <th>Low Coverage Regions (< 10X)</th>
            <th>No Coverage Regions (0X)</th>
        </tr>
        {% for data_info in coverage_stat %}
            <tr>
                <td>{{ data_info[0] }}</td>
                <td>{{ data_info[1] }}</td>
                <td>{{ data_info[2] }}</td>
                <td>{{ data_info[3] }}</td>
                <td>{{ data_info[4] }}</td>
                <td>{{ data_info[5] }}</td>
                <td>{{ data_info[6] }}</td>
                <td>{{ data_info[7] }}</td>
            </tr>
        {% endfor %}
    </table>

    <style>
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 5px 16px;
            transition: 0.3s;
        }

        .tab button:hover {
            background-color: #ddd;
        }

        .tab button.active {
            background-color: #ccc;
        } 
        
        .chart-container {
            display: none;
            padding: 6px 12px;
        }

        #table_id {
            font-family: Arial, Helvetica, sans-serif;
            border-collapse: collapse;
            padding-top: 1%;
            width: 100%;
        }

        #table_id td, #table_id th {
            border: 1px solid #ddd;
            padding: 8px;
        }

        #table_id tr:nth-child(even){
            background-color: #f2f2f2;
        }

        #table_id tr:hover {
            background-color: #ddd;
        }

        #table_id tr {
            justify-content: space-between;
        }

        #table_id th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #04AA6D;
            color: white;
            justify-content: space-between;
        }
    </style>

    <script>

        (function() {
            containers = document.getElementsByClassName("chart-container");
            if(containers.length > 0) {
                containers[0].style.display = "block";
            }
        })()

        function showChart(evt, chartID) {
            let containers = document.getElementsByClassName("chart-container");
            for (let i = 0; i < containers.length; i++) {
                    containers[i].style.display = "none";
            }

            let tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = "tablinks";
            }

            document.getElementById(chartID).style.display = "block";
            evt.currentTarget.className += " active";
        }
    </script>


    <script>
        var samples = {{ samples_name }}
        var ref_seq = "{{ ref_seq }}";
        
        var ref_len = ref_seq.length;
        var depths = {{ depth_data }};
        // create array from range 0 to (ref_len + 1)
        var positions = [...Array(ref_len + 1).keys()];
        // remove zero
        positions.shift();

        //var maxDepth = Math.max(...depths.flat());
        window.depths = depths;
        var $chart = document.getElementById('chart');
        window.$chart = $chart;
        var chart = echarts.init($chart, 'white', {renderer: 'canvas'});
        window.chart = chart;
        /////////////// Define Gene Feature /////////////////////
        var utr_5_start = 1
        var utr_5_end = 265

        var orf1ab_start = 266
        var orf1ab_end = 21555

        var s_start = 21563
        var s_end = 25384

        var orf3a_start = 25393
        var orf3a_end = 26220

        var e_start = 26245
        var e_end = 26472

        var m_start = 26523
        var m_end = 27191

        var orf6_start = 27202
        var orf6_end = 27387

        var orf7a_start = 27394
        var orf7a_end = 27759

        var orf8a_start = 27894
        var orf8a_end = 28259

        var n_start = 28274
        var n_end = 29533

        var orf10_start = 29558
        var orf10_end = 29674

        var utr_3_start = 29675
        var utr_3_end = 29903

        var rdb_start = 22000
        var rdb_end = 22500

        var  annotation_data  = [
            {
                name: "5' UTR" ,
                value: [0, utr_5_start , utr_5_end, 0],
                itemStyle: {
                    color:  '#a6cee3',
                }
            },
            {
                name: 'ORF1ab' ,
                value: [1, orf1ab_start , orf1ab_end, 0],
                itemStyle: {
                    color:  '#1f78b4'
                }
            },
            {
                name:  'S' ,
                value: [2, s_start , s_end, 0],
                itemStyle: {
                    color:  '#b2df8a'
                }
            },
            {
                name:  'ORF3a' ,
                value: [3, orf3a_start , orf3a_end, 0],
                itemStyle: {
                    color:  '#33a02c'
                }
            },
            {
                name:  'E' ,
                value: [4, e_start , e_end, 0],
                itemStyle: {
                    color:  '#fb9a99'
                }
            },
            {
                name:  'M' ,
                value: [5, m_start , m_end, 0],
                itemStyle: {
                    color:  '#e31a1c'
                }
            },
            {
                name:  'ORF6' ,
                value: [6, orf6_start , orf6_end, 0],
                itemStyle: {
                    color:  '#fdbf6f'
                }
            },
            {
                name:  'ORF7a' ,
                value: [7, orf7a_start , orf7a_end, 0],
                itemStyle: {
                    color:  '#ff7f00'
                }
            },
            {
                name:  'ORF8a' ,
                value: [8, orf8a_start , orf8a_end, 0],
                itemStyle: {
                    color:  '#cab2d6'
                }
            },
            {
                name:  'N' ,
                value: [9, n_start , n_end, 0],
                itemStyle: {
                    color:  '#6a3d9a'
                }
            },
            {
                name:  'ORF10' ,
                value: [10, orf10_start , orf10_end, 0],
                itemStyle: {
                    color:  '#FF33D3'
                }
            },
            {
                name: "3' UTR" ,
                value: [11, utr_3_start , utr_3_end, 0],
                itemStyle: {
                    color:  '#b15928'
                }
            },
            
            {
                name: 'RBD' ,
                value: [12, rdb_start , rdb_end, 25],
                itemStyle: {
                    color:  '#0006fc',
                },
            } 
            
        ]
        var y_start;
        function renderItem(params, api){
            var categoryIndex = api.value(0);
            
            var start = api.coord([api.value(1), categoryIndex]);
            if (categoryIndex==0){
                y_start = start[1]
            }
            var end = api.coord([api.value(2), categoryIndex]);
            var height = api.size([0,1])[1] * 15;
            var width = end[0] - start[0] ;
            var x = start[0];
            var y = y_start - height/2  - api.value(3);
            /* 5 Points of shape
            --------------------
            |                     \
            |                      \
            |                      /
            |                     /
            --------------------                
            */                     
            var points = [
                [x, y],
                [x + width - 5 , y],
                [x + width , y - height / 2 ],
                [x + width - 5 , y - height ],
                [x, y - height ]
            ]
            var shape = echarts.graphic.clipPointsByRect(points, 
                {
                    x: params.coordSys.x,
                    y: params.coordSys.y,
                    width: params.coordSys.width,
                    height: params.coordSys.height
            });
            return shape && {
                type: 'polygon',
                shape: {
                    points: shape
                },
                style : api.style(
                    {   
                        stroke: 'black', // border of shape, filled with black
                    }
                ),
                textContent: {
                    type: 'text',
                    style: {
                        text: annotation_data[categoryIndex].name, 
                        fill: annotation_data[categoryIndex].itemStyle.color,
                        fontStyle: 'normal',
                        fontSize: 12,
                        fontWeight: 'bolder'
                    }
                },
                textConfig:{
                    position: 'top', // Place text on top of the shape
                    distance: 20, // text distance to shape
                    rotation: 0.7, // Rotate text for 0.7 radian
                }
            };
        }

        function gene_feature_series(){
            var feature_series =[]
            feature_series.push(
                {
                "type": "custom",
                "xAxisIndex": samples.length,
                "yAxisIndex": samples.length,
                "renderItem":renderItem,
                "data": annotation_data,
                "tooltip":{
                    "trigger": "item",
                    "enterable": "true",
                    "appendToBody": "true",
                    "renderMode": "html",
                    "borderRadius": 6,
                    "borderWidth": 2,
                    "textStyle": {
                        "fontSize": 15,
                        "fontWeight": "bolder"
                    },
                    "formatter": function (params){
                        var output = ''
                        output += 'Feature Name: ' +  params.name + '<br/>' + 'Start pos: ' + params.value[1] + '<br/>' + 'End pos: ' + params.value[2] + '<br/>' + 'Feature length: ' + (params.value[2] - params.value[1] + 1)
                        return output
                    }
                }
            })
            return feature_series
        }
        ///////////////////////////////////////////////////////////


        function getXAxes(samples, ref_len) {
            var axes = [];
            for (var [i, sample] of samples.entries()) {
                axes.push({
                    "type": "value",
                    "gridIndex": i,
                    "min": 1,
                    "max": ref_len,
                    "axisLabel": {
                        "interval": "auto"
                    }
                });
            }
            axes.push({
                    "type": "value",
                    "gridIndex": samples.length,
                    "min": 1,
                    "max": ref_len,
                    "axisLabel": {
                        "interval": "auto"
                    } 
            })
            return axes;
        }
        function getYAxes(samples) {
            var axes = [];
            for (var [i, sample] of samples.entries()) {
                axes.push({
                    "type": "log",
                    "gridIndex": i,
                    "name": sample,
                    "nameTextStyle": {
                        "fontStyle": "normal",
                        "fontWeight": "bolder"
                    },
                    "nameLocation": "end",
                    "min": 1,
                    "max": 100000,
                    "minorSplitLine": 
                    { "show": true}
                });
            }
            axes.push({
                "max": 80,
                "gridIndex": samples.length,
                "show": false
            })
            return axes;
        }
        function getDatasets(depths, positions) {
            var datasets = [];
            for (var [i, depthArray] of depths.entries()) {
                datasets.push({
                    "dimensions": [
                        {"name" : "depth", "type": "int"},
                        {"name": "position", "type": "int"}
                    ],
                    "source": {
                        "position": positions,
                        "depth": depthArray
                    }
                });
            }
            return datasets;
        }

        function getDepthSeries(samples) {
            var series = []
            for (var [i, sample] of samples.entries()) {
                series.push({
                    "type": "line",
                    "xAxisIndex": i,
                    "yAxisIndex": i,
                    "areaStyle": {
                        "color": '#666'
                    },
                    "encode": {
                        "x": "position",
                        "y": "depth",
                    },
                    "symbol": "none",
                    "datasetIndex": i,
                    "lineStyle": {
                        "color": '#666',
                        "opacity": 0
                    },
                    "large": true,
                })
            }
            return series
        }

        var variants = {{ variant_data }}
        window.variants = variants;

        var ntColor = {
            "A": "#F00",
            "C": "#0F0",
            "G": "#00F",
            "T": "#0FF",
        }

        function zoom_index(){
            var indexes = []
            for (var i = 0; i <= samples.length; i++){
                indexes.push(i)
            }
            return indexes
        }
        function getVariantsSeries(variants, depths) {
            // var vars = JSON.parse(JSON.stringify(variants))
            var series = []
            for (var [i, varMap] of variants.entries()) {
                (function(i, varMap) {
                    series.push({
                        "type": "bar",
                        "xAxisIndex": i,
                        "yAxisIndex": i,
                        "data": Object.keys(varMap).map((x) => [parseInt(x), depths[i][x]]),
                        "barWidth": 2,
                        "itemStyle": {
                            "color": function (params) {
                                var pos = params.data[0];
                                var nt = variants[i][pos]
                                if (ntColor.hasOwnProperty(nt[0][0])) {
                                    return ntColor[nt[0][0]]
                                } //else {
                                    //console.log(variants.length, pos, i)
                                //}
                                return "#333";
                            }
                        }
                    })
                })(i, varMap);
            }
            return series
        }

        function getGrids(samples) {
            var n = samples.length + 1;
            var last_height;
            var last_top;
            var grids = Object.keys(samples).map(function (sample) {
                last_height = (1 / n * 100) - 6 
                return {
                    "show": true,
                    "height": (1 / n * 100) - 6 + "%"
                };
            });
            grids.forEach(function (grid, idx) {
                //var padTop = idx === 0 ? 3 : 2
                var padTop = 3
                last_top = (idx / n * 100) + padTop
                grid.top = (idx / n * 100) + padTop + "%"
            })
            grids.push({
                "show": true,
                "height": "8%",
                "top": last_height + last_top + 3 + "%"
            })
            return grids
        }
        function meanCoverage(depths, start, end, gridIndex) {
            var total = 0;
            if (start < end){
                for (var i = start - 1; i <= end - 1; i++){
                    total +=  depths[gridIndex][i]
                }
                return total/(end-start+1)
            }
            else if (start == end){
                return depths[gridIndex][start]
            }
        }

        function genomeCoverage(depths, start, end, gridIndex, low) {
            var total = 0;
            for (var i = start - 1; i <= end - 1; i++){
                if (depths[gridIndex][i] > low){
                    total += 1
                }
            }
            return total/(end-start+1) * 100


        }

        function median(arr) {
            arr.sort( function(a,b) {return a - b;} );
            var half = Math.floor(arr.length/2);
            if(arr.length % 2)
                return arr[half];
            else
                return (arr[half-1] + arr[half]) / 2.0;
        }

        function medianCoverage(depths, start, end, gridIndex) {
            var sub_array = depths[gridIndex].slice(start-1, end)
            return median(sub_array)

        }

        var options = {
            "title": {
            },
            "dataset": getDatasets(depths, positions),
            "xAxis": getXAxes(samples, ref_len),
            "yAxis": getYAxes(samples),
            "series": [...getDepthSeries(samples), ...getVariantsSeries(variants, depths), ...gene_feature_series()],
            "tooltip": [{
                "trigger": "axis",
                "enterable": "true",
                "appendToBody": "true",
                "renderMode": "html",
                "formatter": function (params) {
                    var output = "";
                    var param = params[0];
                    var i = param.axisIndex;
                    if (i < samples.length){
                        var sample = samples[i];
                        var depth = param.data[0];
                        var position = param.data[1];
                        var st = [];
                        var start_pos, end_pos;
                        //start_pos = Math.floor(chart.getOption().dataZoom[0].start * ref_len / 100);
                        start_pos = Math.floor(chart.getOption().dataZoom[0].startValue)
                        //end_pos = Math.floor(chart.getOption().dataZoom[0].end * ref_len / 100);
                        end_pos = Math.floor(chart.getOption().dataZoom[0].endValue)
                        var mean_cov;
                        mean_cov = meanCoverage(depths, start_pos, end_pos, i).toFixed(2);
                        var median_cov;
                        median_cov = medianCoverage(depths, start_pos, end_pos, i).toFixed(2);
                        var genome_cov;
                        genome_cov = genomeCoverage(depths, start_pos, end_pos, i, 10).toFixed(2)
                        output += "<b>" + sample + "</b><br/>" + 'Start pos: ' + start_pos + '<br/>' + 'End pos: ' + end_pos + '<br/>';
                        output += 'Mean Coverage: ' + mean_cov + 'X' + '<br/>';
                        output += 'Median Coverage: ' + median_cov + 'X' + '<br/>';
                        output += 'Genome Coverage ( >= 10x): ' + genome_cov + '%' + '<br/>';
                        output += 'Position: ' + position + '<br/> Coverage Depth: ' + depth + '<br/>';
                        
                        if (variants[i].hasOwnProperty(position)){
                            output += 'Ref: ' + ref_seq.substring(position-1, position-1 + variants[i][position][0].length) + '<br/>'
                        }
                        else{
                            output += 'Ref: ' + ref_seq[position-1] + '<br/>'
                        }
                        if (variants[i].hasOwnProperty(position)) {
                            //console.log(variants[i][position]);
                            output = output + 'Variant: ' + variants[i][position][1]
                        }
                        
                        return output;
                    }
                    else{
                        return output
                    }
                }
            }],
            "toolbox": {
                "show": "true",
                "feature": {
                    "dataView": {
                        "readOnly": "false"
                    },
                    "restore": {},
                    "saveAsImage": {
                        "name": "Coverage_Plot"
                    }
                }
            },
            "dataZoom": [
                {
                    "type": "inside",
                    "filterMode": 'none',
                    "xAxisIndex": [...zoom_index()]
                },
                {
                    "show": "true",
                    "filterMode": 'none',
                    "xAxisIndex": [...zoom_index()],
                    "type": "slider"
                }
            ],
            "grid": getGrids(samples)
        };

        window.options = options;
        chart.setOption(options);
        
        chart.on('click', function(params){
            chart.dispatchAction({
                type:'dataZoom',
                startValue: params.value[1],
                endValue: params.value[2]
            })
        })
        
        // double click to reset dataZoom
        chart.on('dblclick', function(params){
            chart.dispatchAction({
                type:'dataZoom',
                start: 0,
                end: 100
            })
        })
        
        function updateChartDivSize() {
          var BOTTOM_PADDING = 20;
          var top = $chart.getBoundingClientRect().top;
          var height = window.innerHeight - top - BOTTOM_PADDING;
          if (height < 300) {
            height = 300;
          }
          $chart.style.height = height + 'px';
          chart.resize();
        }

        window.addEventListener("resize", updateChartDivSize);
        document.addEventListener("DOMContentLoaded", function(event) {
            updateChartDivSize();
            chart.resize();
        })
    </script>
</body>
</html>