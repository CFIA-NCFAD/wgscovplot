<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive Coverage Plot</title>
    <script src="{{jquery}}"></script>
    <script type="text/javascript" src="{{ echarts_js }}"></script>
    <link href="{{select2_css}}" rel="stylesheet" />
    <script src="{{select2_js}}"></script>
</head>
<body>

    <div class="tab">
        <button class="tablinks" onclick="openNav()">☰ Chart Options</button>
        <button class="tablinks" onclick="showChart(event,'chart')">Coverage Plot</button>
        <button class="tablinks" onclick="showChart(event,'table_id')">Summary Information</button>
    </div>
     
    <div id="chart" class="chart-container" style="width:100%; height: 900px;"></div>

    <div id="mySidepanel" class="sidepanel">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">×</a>
        <button class="accordion">General</button>

        <div class="panel">
            <label for="samples">Samples:</label>
            <select class="selected-samples" multiple="multiple" style="width: 75%" >
                {% for id, sample in samples_name.items() %}
                    <option value={{sample}}>{{sample}}</option>
                {% endfor %}
            </select>
        </div>
        <button class="accordion">Tooltip</button>
        <div class="panel">
            <p>Show Tooltip:  
                <select id="showtooltip" onchange="tooltipOption()">
                    <option value="true" selected>Enable</option>
                    <option value="false">Disable</option>
                </select>
            </p>
        </div>
        <button class="accordion">Data Zoom</button>
        <div class="panel">
            <p>Show Slider:  
                <select id="showslider" onchange="dataZoomOption()">
                    <option value="true" selected>Enable</option>
                    <option value="false">Disable</option>
                </select>
            </p>

            <form id="dataZoom">
                <label for="start_pos">Start Pos:</label><br>
                <input type="number" id="start_pos" value=1><br>
                <label for="start_pos">End Pos:</label><br>
                <input type="number" id="end_pos" value=29903><br><br>
                <input type="button" onclick="setDataZoom()" value="Set DataZoom">
            </form>
        </div>
    </div>
      
    <table id="table_id" class="chart-container">
        <tr>
            <th>Sample Name</th>
            <th>Mean Coverage</th>
            <th>Median Coverage</th>
            <th>Genome Coverage(>= 10x)</th>
            <th>Low Coverage Positions (< 10X) </th>
            <th>No Coverage Positions (0X)</th>
            <th>Low Coverage Regions (< 10X)</th>
            <th>No Coverage Regions (0X)</th>
        </tr>
        {% for data_info in coverage_stat %}
            <tr>
                <td>{{ data_info[0] }}</td>
                <td>{{ data_info[1] }}</td>
                <td>{{ data_info[2] }}</td>
                <td>{{ data_info[3] }}</td>
                <td>{{ data_info[4] }}</td>
                <td>{{ data_info[5] }}</td>
                <td>{{ data_info[6] }}</td>
                <td>{{ data_info[7] }}</td>
            </tr>
        {% endfor %}
    </table>

    <style>
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 5px 16px;
            transition: 0.3s;
        }

        .tab button:hover {
            background-color: #ddd;
        }

        .tab button.active {
            background-color: #ccc;
        } 
        
        .chart-container {
            display: none;
            padding: 6px 12px;
        }

        #table_id {
            font-family: Arial, Helvetica, sans-serif;
            border-collapse: collapse;
            padding-top: 1%;
            width: 100%;
        }

        #table_id td, #table_id th {
            border: 1px solid #ddd;
            padding: 8px;
        }

        #table_id tr:nth-child(even){
            background-color: #f2f2f2;
        }

        #table_id tr:hover {
            background-color: #ddd;
        }

        #table_id tr {
            justify-content: space-between;
        }

        #table_id th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #04AA6D;
            color: white;
            justify-content: space-between;
        }
        .sidepanel  {
            width: 0;
            position: fixed;
            z-index: 1;
            height: 100%;
            top: 0;
            left: 0;
            background-color: #ffff;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
        }

        .sidepanel a {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 18px;
            color: #818181;
            display: block;
            transition: 0.3s;
        }

        .sidepanel a:hover {
            color: #f1f1f1;
        }

        .sidepanel .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
        }

        .openbtn {
            font-size: 15px;
            cursor: pointer;
            background-color: #666;
            color: white;
            padding: 10px 15px;
            border: none;
            display: none
        }

        .openbtn:hover {
            background-color:#444;
        }

        .accordion {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 18px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            transition: 0.4s;
        }

        .active, .accordion:hover {
            background-color: #ccc;
        }

        .accordion:after {
            content: '\002B';
            color: #777;
            font-weight: bold;
            float: right;
            margin-left: 5px;

        }

        .active:after {
            content: "\2212";

        }

        .panel {
            padding: 0 18px;
            background-color: white;
            max-height: 0;
            overflow: scroll;
            transition: max-height 0.2s ease-out;
        }
        
    </style>

    <script>
        (function() {
            containers = document.getElementsByClassName("chart-container");
            if(containers.length > 0) {
                containers[0].style.display = "block";
            }
        })()

        function showChart(evt, chartID) {
            let containers = document.getElementsByClassName("chart-container");
            for (let i = 0; i < containers.length; i++) {
                    containers[i].style.display = "none";
            }

            let tablinks = document.getElementsByClassName("tablinks");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = "tablinks";
            }

            document.getElementById(chartID).style.display = "block";
            evt.currentTarget.className += " active";
        }

        function openNav() {
            document.getElementById("mySidepanel").style.width = "20%";
        }

        function closeNav() {
            document.getElementById("mySidepanel").style.width = "0";
        }
        var acc = document.getElementsByClassName("accordion");

        for (var i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var panel = this.nextElementSibling;
                if (panel.style.maxHeight) {
                panel.style.maxHeight = null;
                } else {
                panel.style.maxHeight = panel.scrollHeight + 200 + "px";
                } 
            });
        }
    </script>


    <script>

        var ref_seq = "{{ ref_seq }}";
        var ref_len = ref_seq.length;
        

        // create array from range 0 to (ref_len + 1)
        var positions = [...Array(ref_len + 1).keys()];
        // remove zero
        positions.shift();

        //window.depths = depths;
        var $chart = document.getElementById('chart');
        window.$chart = $chart;
        var chart = echarts.init($chart, 'white', {renderer: 'canvas'});
        window.chart = chart;


        /////////////// Define Gene Feature /////////////////////
        var gene_feature  = {{ gene_feature }}
        var y_start;
        function renderItem(params, api){
            var categoryIndex = api.value(0);
            
            var start = api.coord([api.value(1), categoryIndex]);
            if (categoryIndex==0){
                y_start = start[1]
            }
            var end = api.coord([api.value(2), categoryIndex]);
            var height = api.size([0,1])[1] * 15;
            var width = end[0] - start[0] ;
            var x = start[0];
            var y = y_start - height/2  - api.value(3);
            /* 5 Points of shape
            --------------------
            |                     \
            |                      \
            |                      /
            |                     /
            --------------------                
            */                     
            var points = [
                [x, y],
                [x + width - 5 , y],
                [x + width , y - height / 2 ],
                [x + width - 5 , y - height ],
                [x, y - height ]
            ]
            var shape = echarts.graphic.clipPointsByRect(points, 
                {
                    x: params.coordSys.x,
                    y: params.coordSys.y,
                    width: params.coordSys.width,
                    height: params.coordSys.height
            });
            return shape && {
                type: 'polygon',
                shape: {
                    points: shape
                },
                style : api.style(
                    {   
                        stroke: 'black'
                    }
                ),
                textContent: {
                    type: 'text',
                    style: {
                        text: gene_feature[categoryIndex].name, 
                        fill: gene_feature[categoryIndex].itemStyle.color,
                        fontStyle: 'normal',
                        fontSize: 12,
                        fontWeight: 'bolder'
                    }
                },
                textConfig:{
                    position: 'top',
                    distance: 20, 
                    rotation: 0.7
                }
            };
        }

        function gene_feature_series(index){
            var feature_series =[]
            feature_series.push({
                type: "custom",
                xAxisIndex: index,
                yAxisIndex: index,
                labelLayout:{
                    //hideOverlap: true,
                },
                renderItem:renderItem,
                data: gene_feature,
                tooltip:{
                    trigger: "item",
                    enterable: true,
                    appendToBody: true,
                    renderMode: "html",
                    borderRadius: 6,
                    borderWidth: 2,
                    showContent: "true",
                    textStyle: {
                        fontSize: 15,
                        fontWeight: "bolder"
                    },
                    formatter: function (params){
                        var output = ''
                        output += 'Feature Name: ' +  params.name + '<br/>' + 'Start pos: ' + params.value[1].toLocaleString() + '<br/>' + 'End pos: ' + params.value[2].toLocaleString() + '<br/>' + 'Feature length: ' + (params.value[2] - params.value[1] + 1).toLocaleString()
                        return output
                    }
                }
            })
            return feature_series
        }
        ///////////////////// End of Gene Feature/////////////////////


        function getXAxes(samples, ref_len) {
            var axes = [];
            for (var [i, sample] of samples.entries()) {
                axes.push({
                    type: "value",
                    gridIndex: i,
                    min: 1,
                    max: ref_len,
                    axisLabel: {
                        interval: "auto"
                    }
                });
            }
            axes.push({
                    type: "value",
                    gridIndex: samples.length,
                    min: 1,
                    max: ref_len,
                    axisLabel: {
                        interval: "auto"
                    } 
            })
            return axes;
        }
        function getYAxes(samples, scaletype, ymax) {
            var axes = [];
            for (var [i, sample] of samples.entries()) {
                axes.push({
                    type: scaletype,
                    gridIndex: i,
                    name: sample,
                    nameTextStyle: {
                        fontStyle: "normal",
                        fontWeight: "bolder"
                    },
                    nameLocation: "end",
                    min: 1,
                    max: ymax,
                    minorSplitLine: { 
                        show: true
                    }
                });
            }
            axes.push({
                max: 80,
                gridIndex: samples.length,
                show: false
            })
            return axes;
        }
        /*
        function getSeries(){

            var variantx = document.getElementById('showvariant').value;
            var series = []
            if (variantx=="true")
            {
                series = [...getDepthSeries(samples), ...getVariantsSeries(), ...gene_feature_series()]
            }
            else{
                series = [...getDepthSeries(samples), ...gene_feature_series()]
            }
            return series
        }
        */

        function getDatasets(depths, positions) {
            var datasets = [];
            for (var [i, depthArray] of depths.entries()) {
                datasets.push({
                    dimensions: [
                        {name : "depth", type: "int"},
                        {name: "position", type: "int"}
                    ],
                    source: {
                        position: positions,
                        depth: depthArray
                    }
                });
            }
            return datasets;
        }

        function getDepthSeries(samples) {
            var series = []
            for (var [i, sample] of samples.entries()) {
                series.push({
                    type: "line",
                    xAxisIndex: i,
                    yAxisIndex: i,
                    areaStyle: {
                        color: '#666'
                    },
                    encode: {
                        x: "position",
                        y: "depth",
                    },
                    symbol: "none",
                    datasetIndex: i,
                    lineStyle: {
                        color: '#666',
                        opacity: 0
                    },
                    large: true,
                })
            }
            return series
        }

        var ntColor = {
            "A": "#F00",
            "C": "#0F0",
            "G": "#00F",
            "T": "#0FF",
        }

        function zoom_index(length){
            var indexes = []
            for (var i = 0; i <= length; i++){
                indexes.push(i)
            }
            return indexes
        }

        function getVariantsSeries(variants, depths) {
            var series = []
            for (var [i, varMap] of variants.entries()) {
                (function(i, varMap) {
                    series.push({
                        type: "bar",
                        xAxisIndex: i,
                        yAxisIndex: i,
                        data: Object.keys(varMap).map((x) => [parseInt(x), depths[i][x]]),
                        barWidth: 2,
                        itemStyle: {
                            color: function (params) {
                                var pos = params.data[0];
                                var nt = variants[i][pos]
                                if (ntColor.hasOwnProperty(nt[0][0])) {
                                    return ntColor[nt[0][0]]
                                } //else {
                                    //console.log(variants.length, pos, i)
                                //}
                                return "#333";
                            }
                        }
                    })
                })(i, varMap);
            }
            return series
            
        }

        function getGrids(samples) {
            var n = samples.length + 1;
            var last_height;
            var last_top;
            var grids = Object.keys(samples).map(function (sample) {
                last_height = (1 / n * 100) - 6 
                return {
                    "show": true,
                    "height": (1 / n * 100) - 6 + "%"
                };
            });
            grids.forEach(function (grid, idx) {
                //var padTop = idx === 0 ? 3 : 2
                var padTop = 3
                last_top = (idx / n * 100) + padTop
                grid.top = (idx / n * 100) + padTop + "%"
            })
            grids.push({
                show: true,
                height: "8%",
                top: last_height + last_top + 3 + "%"
            })
            return grids
        }
        function meanCoverage(depths, start, end, gridIndex) {
            var total = 0;
            if (start < end){
                for (var i = start - 1; i <= end - 1; i++){
                    total +=  depths[gridIndex][i]
                }
                return total/(end-start+1)
            }
            else if (start == end){
                return depths[gridIndex][start]
            }
        }

        function genomeCoverage(depths, start, end, gridIndex, low) {
            var total = 0;
            for (var i = start - 1; i <= end - 1; i++){
                if (depths[gridIndex][i] > low){
                    total += 1
                }
            }
            return total/(end-start+1) * 100


        }

        function median(arr) {
            arr.sort( function(a,b) {return a - b;} );
            var half = Math.floor(arr.length/2);
            if(arr.length % 2)
                return arr[half];
            else
                return (arr[half-1] + arr[half]) / 2.0;
        }

        function medianCoverage(depths, start, end, gridIndex) {
            var sub_array = depths[gridIndex].slice(start-1, end)
            return median(sub_array)

        }


        function getTooltips(samples, depths, variants){
            return [{
                trigger: "axis",
                enterable: true,
                appendToBody: true,
                renderMode: "html",
                showContent: true,
                formatter: function (params) {
                    var output = "";
                    var param = params[0];
                    var i = param.axisIndex;
                    if (i < samples.length){
                        var sample = samples[i];
                        var depth = param.data[0];
                        var position = param.data[1];
                        var start_pos, end_pos;
                        //start_pos = Math.floor(chart.getOption().dataZoom[0].start * ref_len / 100);
                        start_pos = Math.floor(chart.getOption().dataZoom[0].startValue)
                        //end_pos = Math.floor(chart.getOption().dataZoom[0].end * ref_len / 100);
                        end_pos = Math.floor(chart.getOption().dataZoom[0].endValue)
                        var mean_cov;
                        mean_cov = meanCoverage(depths, start_pos, end_pos, i).toFixed(2);
                        var median_cov;
                        median_cov = medianCoverage(depths, start_pos, end_pos, i).toFixed(2);
                        var genome_cov;
                        genome_cov = genomeCoverage(depths, start_pos, end_pos, i, 10).toFixed(2)
                        output += "<b>" + sample + "</b><br/>" + 'Start pos: ' + start_pos.toLocaleString() + '<br/>' + 'End pos: ' + end_pos.toLocaleString() + '<br/>';
                        output += 'Mean Coverage: ' + mean_cov + 'X' + '<br/>';
                        output += 'Median Coverage: ' + median_cov + 'X' + '<br/>';
                        output += 'Genome Coverage ( >= 10x): ' + genome_cov + '%' + '<br/>';
                        output += 'Position: ' + position.toLocaleString() + '<br/> Coverage Depth: ' + depth.toLocaleString() + '<br/>';
                        
                        if (variants[i].hasOwnProperty(position)){
                            output += 'Ref: ' + ref_seq.substring(position-1, position-1 + variants[i][position][0].length) + '<br/>'
                        }
                        else{
                            output += 'Ref: ' + ref_seq[position-1] + '<br/>'
                        }
                        if (variants[i].hasOwnProperty(position)) {
                            //console.log(variants[i][position]);
                            output = output + 'Variant: ' + variants[i][position][1]
                        }
                        
                        return output;
                    }
                    else{
                        return output
                    }
                }
            }] 
        }  

        var gird_index_length;

        function getOptions(){   
            
            var default_num_chart = 3;

            // Original data
            var origin_samples = {{ samples_name }}
            var origin_depths = {{ depth_data }};
            var origin_variants = {{ variant_data }};

                        
            var samples = [];
            var depths = []
            var variants = []

            for (const [key, entries] of Object.entries(origin_samples)){
                if (key < default_num_chart){
                    samples.push(entries)
                    depths.push(origin_depths[entries])
                    variants.push(origin_variants[entries])
                }
            }
            gird_index_length = samples.length
            var options = {
                title: {
                },
                dataset: getDatasets(depths, positions),
                xAxis: getXAxes(samples, ref_len),
                yAxis: getYAxes(samples, "log", 100000),
                series: [...getDepthSeries(samples),...getVariantsSeries(variants, depths), ...gene_feature_series(gird_index_length)],
                tooltip: getTooltips(samples, depths, variants),
                toolbox: {
                    show: "true",
                    feature: {
                        dataView: {
                            readOnly: false
                        },
                        restore: {},
                        saveAsImage: {
                            name: "Coverage_Plot"
                        }
                    }
                },
                dataZoom: [
                    {
                        type: "inside",
                        filterMode: 'none',
                        xAxisIndex: [...zoom_index(gird_index_length)]
                    },
                    {
                        show: true,
                        filterMode: 'none',
                        xAxisIndex: [...zoom_index(gird_index_length)],
                        type: "slider"
                    }
                ],
                grid: getGrids(samples)
            };
            return options
        }

        function tooltipOption(){
            var tooltipx = document.getElementById('showtooltip').value;
            if (tooltipx=="false"){
                chart.setOption({
                    tooltip:[{showContent: false}]
                });
            }
            else{
                chart.setOption({
                    tooltip:[{showContent: true}]
                });
            }
        }

        function dataZoomOption(){
            var sliderx = document.getElementById('showslider').value;
            if (sliderx=="false"){
                chart.setOption({
                    dataZoom: [
                    {
                        type: "inside",
                        filterMode: 'none',
                        xAxisIndex: [...zoom_index(gird_index_length)]
                    },
                    {
                        show: false,
                        type: "slider"
                    }
                ]
                });
            }
            else{
                chart.setOption({
                    dataZoom: [
                    {
                        type: "inside",
                        filterMode: 'none',
                        xAxisIndex: [...zoom_index(gird_index_length)]
                    },
                    {
                        show: true,
                        filterMode: 'none',
                        xAxisIndex: [...zoom_index(gird_index_length)],
                        type: "slider"
                    }
                ]
                });
            } 
        }
        
        function setYMax(){

            var ymax = document.getElementById('ymax').value;
            chart.setOption({
                yAxis: getYAxes(samples, scalex, ymax),
            })
        
        }
        
        chart.on('click', function(params){
            chart.dispatchAction({
                type:'dataZoom',
                startValue: params.value[1],
                endValue: params.value[2]
            })
        })
        
        chart.on('dblclick', function(params){
            chart.dispatchAction({
                type:'dataZoom',
                start: 0,
                end: 100
            })
        })

        function updateCoveragePlot(samples){   
            
            var origin_depths = {{ depth_data }};
            var origin_variants = {{ variant_data }};

            var depths = []
            var variants = []

            for (const selected_samples of samples){
                depths.push(origin_depths[selected_samples])
                variants.push(origin_variants[selected_samples])
            }
            gird_index_length = samples.length
            var options = {
                title: {
                },
                dataset: getDatasets(depths, positions),
                xAxis: getXAxes(samples, ref_len),
                yAxis: getYAxes(samples, "log", 100000),
                series: [...getDepthSeries(samples),...getVariantsSeries(variants, depths), ...gene_feature_series(gird_index_length)],
                tooltip: getTooltips(samples, depths, variants),
                toolbox: {
                    show: "true",
                    feature: {
                        dataView: {
                            readOnly: false
                        },
                        restore: {},
                        saveAsImage: {
                            name: "Coverage_Plot"
                        }
                    }
                },
                dataZoom: [
                    {
                        type: "inside",
                        filterMode: 'none',
                        xAxisIndex: [...zoom_index(gird_index_length)]
                    },
                    {
                        show: true,
                        filterMode: 'none',
                        xAxisIndex: [...zoom_index(gird_index_length)],
                        type: "slider"
                    }
                ],
                grid: getGrids(samples)
            };
            chart.setOption(option = options, notMerge = true);

        }

        function updateChartDivSize() {
          var BOTTOM_PADDING = 20;
          var top = $chart.getBoundingClientRect().top;
          var height = window.innerHeight - top - BOTTOM_PADDING;
          if (height < 300) {
            height = 300;
          }
          $chart.style.height = height + 'px';
          chart.resize();
        }

        window.addEventListener("resize", updateChartDivSize);
        document.addEventListener("DOMContentLoaded", function(event) {
            updateChartDivSize();
            chart.resize();
        })

        chart.setOption(option = getOptions());

        $(document).ready(function() {
            $('.selected-samples').select2();
            $(".selected-samples").on("change", function (e) {
                var selectData = $(".selected-samples").select2("data");
                var samples_list = []
                for (var [key, entries] of selectData.entries()){
                   samples_list.push(selectData[key].text)
                }
                updateCoveragePlot(samples_list)
            });

        });

        function setDataZoom(){
            var start = document.getElementById('start_pos').value
            var end = document.getElementById('end_pos').value
            submitDataZoom(end, start)

        }

        function submitDataZoom (start, end) {
            chart.dispatchAction({
                type:'dataZoom',
                startValue: start,
                endValue: end
            })
        }
    </script>
</body>
</html>